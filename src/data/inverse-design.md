# 逆設計（Inverse materials design）

逆設計とは、所望の物性・機能・性能を先に定め、その条件を満たす材料（組成・構造・プロセス）を探索・提案する設計枠組みである。機械学習の観点では、予測モデル（順問題）と最適化・生成（逆問題）を組み合わせ、試行回数やコストを抑えつつ探索を進める体系である。

## 参考ドキュメント
- B. Sanchez-Lengeling, A. Aspuru-Guzik, Inverse molecular design using machine learning, Science (2018)
  https://www.science.org/doi/10.1126/science.aat2663
- H. Park et al., Has generative artificial intelligence solved inverse materials design?, Matter (2024)
  https://www.cell.com/matter/fulltext/S2590-2385%2824%2900242-X
- 三菱総研DCS（MKI）コラム：マテリアルズ・インフォマティクスのABC〜ベイズ最適化による材料合成の最適化（日本語）
  https://www.mki.co.jp/knowledge/solution/column150.html


## 1. 順問題と逆問題（定式化）
材料表現（設計変数）を $x$、物性・性能を $y$ として、順問題は
$$
y = f(x)
$$
である。逆設計は、目標 $y*$ の達成や効用最大化を目的として、次の最適化として書ける。

目標到達（targeting）
$$
x* = argmin_x  D(f(x), y*)
$$
最適化（maximize/minimize）
$$
x* = argmax_x  U(f(x))
$$
制約付き（現実の材料設計では必須）
$$
x* = argmax_x U(f(x))
s.t.  g_i(x) ≤ 0  (安定性、合成可能性、コスト、毒性、プロセス窓など)
$$
ここで D は距離（例：二乗誤差）、U は目的関数、g_i は制約である。材料では x が離散（元素種、構造タイプ）と連続（組成比、格子、プロセス条件）が混在し、制約も多いことから、逆問題は一般に不適切（ill-posed）になりやすい。

## 2. 逆設計が難しい理由（材料特有の構造）
1) 多対一（one-to-many）
同じ目標特性 $y*$ を満たす材料候補 x は多数存在しうる。したがって「y → x」を一意に回帰する発想は破綻しやすい。

2) 離散・連続の混在
元素置換、結晶系、欠陥サイトなどは離散であり、組成・格子定数・プロセス条件は連続である。探索空間が組合せ爆発しやすい。

3) 物理・化学制約の存在
電荷中性、原子間距離、配位、PBC、熱力学安定性、相分離、合成経路などが暗黙の制約として効く。

4) 評価コストの高さ
DFT、MD、実験はいずれも高コストであり、クエリ効率（少ない試行で当てる設計）が支配的になる。

## 3. 代表的アプローチ（機械学習の観点）
逆設計は大きく、最適化ベース、生成ベース、逆写像ベースに分けられる。実務ではこれらを混成して使うことが多い。

### 3.1 最適化ベース：代理モデル（surrogate）＋探索
順問題モデル $f̂(x)$ を学習し、それを用いて $x$ を探索する枠組みである。

(1) ベイズ最適化（Bayesian optimization: BO）
未知関数の最適化を、代理モデル（例：ガウス過程、確率的ニューラルネット）と獲得関数で逐次的に進める。

典型的なループ
- 初期点を少数評価してデータを作る
- 代理モデルを学習する
- 獲得関数 $a(x)$（探索と活用のバランス）を最大化する点を次に評価する
- データを追加して繰り返す

多目的・制約付きBOでは、Pareto最適性と制約違反確率などを組み込み、現実的な探索に寄せる。

(2) 進化計算・遺伝的アルゴリズム
離散変数を含む探索に強く、候補集合を世代更新する。代理モデルと組み合わせて評価回数を節約する構成も多い。

(3) 勾配ベース（differentiable design）
$x$ が連続で、$f̂$ が微分可能ならば
$$
x ← x + α ∂U(f̂(x))/∂x
$$
のように勾配上昇で設計変数を更新できる。離散変数は緩和（連続化）や確率的表現（Gumbel-Softmax等）が必要である。

### 3.2 生成ベース：候補分布を学習して出す
p(x) または p(x|c)（c は目標物性や条件）を学習し、候補をサンプルして評価・絞り込みする。

(1) 潜在変数モデル（VAE等）＋潜在空間最適化
x → z（潜在表現）を学習し、z 空間で BO や勾配法を行い、復号して候補を得る。潜在空間の連続性が鍵である。

(2) GAN
生成器が一括生成できる利点があり、組織画像・スペクトルなどに適用しやすい。一方で学習の不安定性や多様性低下に注意が必要である。

(3) 拡散モデル（Diffusion models）
ノイズから段階的にデノイズしてサンプルを生成する。学習安定性と多様性の点で優位になりやすく、近年は結晶構造（元素種・座標・格子）を直接生成する研究も進展している。

(4) 正規化フロー（Normalizing flows）
可逆変換により、密度評価とサンプリングの両方を行える。逆設計では「所望条件に合う領域へ写像する」設計が取りやすい。

生成ベースは「候補を大量に出す」ことが得意であり、後段で妥当性フィルタ、構造緩和、物性再評価を組み合わせて運用するのが基本である。

### 3.3 逆写像ベース：y → x を直接学習する
単純な回帰では多対一により破綻しやすいが、以下の工夫で成立しうる。
- 条件付き生成（c = y* として p(x|y*) を学習）
- 複数解を表現できるモデル（混合密度、確率的デコーダ）
- 追加の制約や正則化で解集合を狭める（合成プロセス制約など）

## 4. 多目的最適化とPareto設計
材料設計は多目的であることが多い（例：高磁化と低損失、強度と靭性、導電率と安定性など）。
目的ベクトルを $y(x) = [y1(x), y2(x), ...]$ とすると、Pareto最適は
ある目的を改善すると別の目的が悪化するため、支配されない解集合として定義される。

実務では以下が多い。
- 重み付き和：$U = Σ_k w_k y_k$（簡単だが重み設計が難しい）
- 目標到達型：各特性を目標範囲に入れる確率を最大化する
- 制約化：最重要以外を制約として扱う（例：磁化最大化 s.t. 損失 ≤ 閾値）

## 5. 材料表現（何をxとして設計するか）
逆設計の成否は、モデルよりも表現と制約設計に依存しやすい。

| 設計対象 | x の例 | 典型モデル | 典型の制約 |
|---|---|---|---|
| 組成探索 | 元素比、置換サイト | MLP、GPR、Transformer | 化学量論、毒性、コスト |
| 結晶構造探索 | 元素種＋座標＋格子 | GNN、等変性モデル、拡散 | PBC、最小距離、安定性 |
| 欠陥・界面 | 欠陥種、濃度、配置 | GNN、クラスター展開＋ML | 電荷中性、局所配位 |
| 組織設計 | 画像/ボクセル、統計量 | CNN、GAN、拡散 | 体積分率、相関関数、連結性 |
| プロセス設計 | 温度、時間、雰囲気等 | BO、サロゲート＋最適化 | 装置制約、再現性、コスト |

## 6. 実務フロー（閉ループ最適化の標準形）
逆設計は、生成・最適化だけで完結せず、評価と更新を繰り返す閉ループ運用が基本である。

1) 初期データ整備
- 既存データ（文献、DB、過去実験、DFT）を整理し、表現xと条件を統一する

2) 代理モデル学習
- f̂(x) を学習し、必要なら不確かさも推定する

3) 提案（最適化または生成）
- BOや生成モデルで候補を提案する（制約も加味する）

4) 妥当性フィルタ
- 化学・幾何制約のチェック、簡易計算で足切りする

5) 高コスト評価
- DFT/MD/実験で評価し、データを追加する

6) 反復
- モデル更新と探索方針更新を行い、目的達成まで繰り返す

## 7. 評価（逆設計で何をもって成功とするか）
生成や探索の評価は、単一指標では不十分である。少なくとも次を分けて見るのが実務的である。

- 有効性（validity）：制約を満たす候補の割合
- 多様性（diversity）：似た候補ばかりになっていないか
- 新規性（novelty）：学習データの再生産ではないか
- 目標達成率（hit rate）：目標範囲に入る割合
- コスト効率：目標到達までの評価回数（DFT回数、実験回数）
- 再現性：プロセス条件下で再現できるか

## まとめ
逆設計は、順問題モデル（予測）だけでは達成できず、最適化・生成・制約処理を統合した探索システムとして設計する必要がある。機械学習の観点では、(1) 代理モデル＋逐次探索（BO等）、(2) 生成モデルによる候補提案、(3) 条件付き分布や逆写像の学習、を問題構造（離散/連続、制約、多目的、評価コスト）に応じて組み合わせることが要点である。材料では表現設計と妥当性制約、そして緩和・検証を含む閉ループ運用が支配的である。

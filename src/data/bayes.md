# ベイズ統計入門

ベイズ統計は、確率を「不確実性（わからなさ）」の度合いとして扱い、観測データと既存知識（理論・過去実験・DFT等）を統合して推論する枠組みである。

- 推定結果を「点」ではなく分布（確率）として得られる（= 不確かさ込み）
- 少数データでも推定はできるが、事前分布の影響が相対的に強くなりやすい（根拠ある事前設定と感度解析が重要）
- 材料科学では、高コスト測定（ビームタイム制約）や高コスト計算（DFT）、ばらつき・ノイズが大きい測定（例：磁気雑音、薄膜特性）と相性が良い


## 参考ドキュメント

- PHYSBO（物理・材料向けベイズ最適化ライブラリ）公式マニュアル（日本語）  
  https://issp-center-dev.github.io/PHYSBO/manual/master/ja/introduction.html  

- 神戸大学 分寺杏介「ベイズ統計 イントロダクション」講義資料（PDF）  
  https://www2.kobe-u.ac.jp/~bunji/files/lecture/bayes/bayes-01-introduction.pdf  

- 材料分野のベイズ最適化（書籍章・スライド等の一覧：一杉研究室）  
  https://solid-state-chemistry.jp/english/output_books.html  


## 1. ベイズの定理と用語

### ベイズの定理

$$
p(\theta \mid D) = \frac{p(D \mid \theta)\,p(\theta)}{p(D)}
$$

- $D$: 観測データ（例：10枚の薄膜の保磁力、10条件の鉄損、MBN特徴量など）
- $\theta$: 未知パラメータ（例：平均値、回帰係数、ノイズ分散、相境界パラメータなど）

| 記号 | 名称 | 意味（材料データの例） |
|---|---|---|
| $p(\theta)$ | 事前分布 Prior | 文献値・経験・DFT推定を反映（例：保磁力の平均はこの程度） |
| $p(D\mid\theta)$ | 尤度 Likelihood | 測定誤差モデル（例：測定値は真値の周りに正規ノイズ） |
| $p(\theta\mid D)$ | 事後分布 Posterior | データで更新された「推定結果（分布）」 |
| $p(D)$ | 周辺尤度 Evidence | 正規化定数。モデル比較（ベイズ因子等）に使う |

Evidence（周辺尤度）の定義：
$$
p(D)=\int p(D\mid\theta)\,p(\theta)\,d\theta
$$


## 2. 頻度論（通常の統計）との違い

- 信頼区間（Confidence Interval）と信用区間（Credible Interval）は別物である  
  - 信用区間：$p(\theta\mid D)$の区間（「パラメータがこの範囲にある確率が95%」と読める）
- 「少数データに強い」は魔法ではない  
  - 事前分布が効くため、“根拠ある事前”と“事前感度（弱情報事前との比較）”が鍵になる


## 3. 少数試料の物性平均を推定する（正規–正規モデル）

### 状況
薄膜10枚の保磁力 $y_1,\dots,y_n$ を測った。測定誤差（標準偏差）$\sigma$ が概ね既知とする。

### モデル
$$
y_i \sim \mathcal{N}(\mu,\sigma^2),\quad
\mu \sim \mathcal{N}(\mu_0,\tau_0^2)
$$

### 事後分布
$$
\mu\mid D \sim \mathcal{N}(\mu_N,\tau_N^2)
$$

$$
\tau_N^2 = \left(\frac{1}{\tau_0^2}+\frac{n}{\sigma^2}\right)^{-1},\quad
\mu_N = \tau_N^2\left(\frac{\mu_0}{\tau_0^2}+\frac{n\bar{y}}{\sigma^2}\right)
$$

読み方（直感）
- $\mu_N$ は「事前平均 $\mu_0$」と「標本平均 $\bar{y}$」の重み付き平均
- $n$ が増えるほど $n/\sigma^2$ が大きくなり、データが支配的になる

### 予測分布
$$
y_{\text{new}}\mid D \sim \mathcal{N}(\mu_N,\ \sigma^2+\tau_N^2)
$$
→ 予測の不確かさ（測定ノイズ + 推定不確かさ）が自然に入る。


## 4. 代表的な事前分布

| 目的（例） | 観測（尤度） | 事前分布の例 | 備考 |
|---|---|---|---|
| 成功率・合格率（歩留まり、欠陥発生率） | 二項分布 | ベータ分布 | Beta–Binomial（共役） |
| 多相比率・カテゴリ比（相分率、結晶相ラベル比） | 多項分布 | ディリクレ分布 | Dirichlet–Multinomial |
| 連続値の平均（磁化、保磁力、格子定数） | 正規分布 | 正規分布 | 測定誤差が概ね正規なら相性が良い |
| 分散（ばらつき） | 正規分布 | 逆ガンマ/半正規/半Cauchy | 実務では**“弱情報”のスケール事前**もよく使う |


## 5. 推論手法

### 5.1 共役（解析解）を使う
上の正規–正規のように、式で解ける場合は速くて堅牢。

### 5.2 MCMC（Markov Chain Monte Carlo）
事後分布からサンプルを生成して近似する手法。  
Metropolis–Hastings、Gibbs、HMC（Hamiltonian Monte Carlo）、NUTSなど。

材料での用途例
- 弾性定数・磁歪定数・内部応力など、複数パラメータ同時推定
- ノイズが大きい測定（MBN、鉄損、薄膜のばらつき）での頑健推定

### 5.3 収束診断
- 複数チェーンを回す（目安：4本）
- R-hat が 1 に近い（例：< 1.05 を目安にすることが多い）
- 有効サンプルサイズ（ESS）が十分  
（R-hat/ESSはStanやArviZ等が計算できる）


## 6. ベイズ回帰
材料データの“関係式”を不確かさ付きで学習

### 線形回帰
$$
y = X\beta + \epsilon,\quad \epsilon\sim\mathcal{N}(0,\sigma^2 I)
$$

事前として
$$
\beta \sim \mathcal{N}(0,\lambda^{-1}I)
$$
を置くと、過学習を抑える（正則化）効果を自然に持つ。  
（頻度論のリッジ回帰と近いが、ベイズでは「$\beta$の不確かさ」が分布で出る。）

### DFT と実験の統合（校正）の例
$$
y_{\text{exp}} = a + b\,y_{\text{DFT}} + \epsilon
$$
- $a,b$ に事前を置くことで、文献知識や系統誤差を織り込んだ校正ができる
- 実験点が少ないときに特に有効


## 7. 階層モデル

同一条件でも試料ごとに特性がズレる（薄膜のロット差、欠陥密度差など）状況で有用。

例：試料 $i$ を繰り返し測定 $j$
$$
y_{ij} \sim \mathcal{N}(\mu_i,\sigma_{\text{meas}}^2),\quad
\mu_i \sim \mathcal{N}(\mu_{\text{global}},\sigma_{\text{sample}}^2)
$$

- $\sigma_{\text{meas}}$：測定誤差
- $\sigma_{\text{sample}}$：試料間ばらつき（製膜・合成変動）
→ 「ばらつきの原因分解」ができ、次の改善（プロセス制御）につながる。


## 8. ベイズ最適化（材料探索・合成条件最適化）

高価な評価（DFT、成膜＋測定、放射光測定）を少ない試行回数で最適化したいときに使う。

### 8.1 基本アイデア
1. これまでの試行 $\{(x_k, y_k)\}$ から、目的関数 $f(x)$ を確率モデル（多くはガウス過程）で近似
2. 不確実性も含めた獲得関数（EI, UCB など）で「次に試す $x$」を決める
3. 実験/計算で $y$ を得てデータ更新 → 1へ戻る（closed-loop）

### 8.2 材料での“ありがち設計”
- $x$：組成（離散候補）、温度、酸素分圧、アニール時間、スパッタ条件など
- $y$：保磁力、磁歪、鉄損、導電率、XRDピーク指標、目的関数化した性能指数など
- 条件に制約がある（装置限界、相安定性）→ 制約付きBOへ拡張
# スーパーコンピュータ 東北大学MASAMUNE-II の使い方

## 参考ドキュメント 
- [MASAMUNE-弐ユーザーマニュアル](https://www.sc.imr.tohoku.ac.jp/masamune/manual/)
- [計算材料学センター](https://www.sc.imr.tohoku.ac.jp/index.html)
- CCMS User Application（利用申請・共同利用の手順）  
  - https://www.sc.imr.tohoku.ac.jp/eng/masamune/system.html から “User Application” などへ

---

## 概要

MASAMUNE-II は、材料科学計算のためのスーパーコンピュータであり、

1. **プロジェクト申請とユーザ ID の取得**  
2. **SSH 公開鍵の登録とログイン設定**  
3. **ファイル領域（/home, /work）の使い分け**  
4. **ジョブスクリプトの作成とキュー選択**  
5. **ジョブ投入・監視・結果整理**

という流れで利用する。  
計算はすべて **ジョブスケジューラ（PBS）経由のバッチジョブ**として実行し、  
ログインノードでは編集・確認・小さなテスト程度にとどめる。

---

## 詳細

### 1. 利用開始までの流れ

- **プロジェクト申請**  
  CCMS の共同利用・コンソーシアム等の枠で申請し、採択されると  
  - プロジェクト番号  
  - ユーザ ID（UID）  
  が発行される。論文や発表では、このプロジェクト番号を謝辞に記載する。

- **SSH 公開鍵の登録**  
  CCMS の鍵登録サイトから公開鍵・秘密鍵を生成し、  
  公開鍵をサーバに登録する。秘密鍵はローカル PC に安全に保存し、  
  以後は公開鍵認証で `cms-ssh` → `super`（CPU）/`gpu`（GPU）へ接続する。

- **SSH 設定のイメージ**  
  ローカル側では `cms-ssh.sc.imr.tohoku.ac.jp` を中継し、  
  `super.sc.imr.tohoku.ac.jp`（CPU フロント）、  
  `gpu.sc.imr.tohoku.ac.jp`（GPU フロント）にログインするよう設定する。

---

### 2. ファイル領域の役割

- **/home/UID**  
  - 容量は固定（例：500 GB 程度）。  
  - ソースコード、ジョブスクリプト、設定ファイル、軽い結果の保管場所。  
  - 大量の出力や一時ファイルを置く場所ではない。

- **/work 以下の領域**  
  - 大規模計算用の Lustre 領域。  
  - 入力ファイルをコピーし、ジョブはここから実行する。  
  - バックアップは基本的にないため、重要なデータは必要に応じてローカルへ退避。

- **/work/scratch**  
  - 一時ファイル向け。一定期間アクセスがないと自動削除される想定。  
  - 再生成可能な中間データなどを置く。

**基本方針**：  
「/home に環境とスクリプト」「/work に計算データと結果」という分担を徹底する。

---

### 3. ジョブスケジューラとキューの概念

MASAMUNE-II では PBS 系のジョブスケジューラを使う。

- **ジョブスクリプト**  
  - 上部に「キュー名」「ノード数」「実行時間」「ジョブ名」などの指示（PBS オプション）を書く。  
  - 本文で
    - 利用するモジュールの読み込み（コンパイラ、MPI、アプリケーション）  
    - 計算ディレクトリへの移動  
    - 実行コマンド  
    を順に記述する。

- **キューの選び方（CPU 側の代表的なイメージ）**
  - 一般的な並列計算 → **P_030**（標準キュー）  
  - 小規模・短時間のテスト → **CP_001** や **DP_002**（共有・デバッグ用）  
  - 大容量メモリノードが必要 → **MP_001**  
  - 非常に大規模・長時間の特別なジョブ → マニュアルの専用キュー解説を参照

GPU 計算の場合は、`gpu` フロントから GPU 用キューを利用し、  
マニュアルに掲載された LAMMPS や CP2K のサンプルジョブを参考にする。

---

### 4. 典型的な作業の流れ（CPU 版の例）

1. ローカル PC で入力ファイルを準備する。  
2. `/work` 以下に、プロジェクトごとのディレクトリ（例：`/work/プロジェクト/UID/vasp/Fe4N/`）を作成し、入力ファイルを転送する。  
3. そのディレクトリでジョブスクリプトを作成し、キュー（例：P_030）・ノード数・実行時間を決める。  
4. ジョブを投入し、キューの待ち行列と実行状態を確認する。  
5. 計算終了後、ログや出力ファイルをチェックし、必要なものだけを `/home` またはローカルにコピーする。  
6. `/work` 内の不要ファイルは適宜削除し、ディスク使用量を管理する。

---

### 5. 運用上のチェックポイント

- `/home` に巨大な結果や中間ファイルを溜め込まない。  
- 大規模ジョブを流す前に、デバッグ用キューで小規模テストを行う。  
- モジュールやアプリケーションのバージョンは、ジョブスクリプト内に明示しておく。  
- プロジェクトの利用ノード時間・ディスク使用量を意識し、定期的に整理する。  
- 論文・学会発表では、CCMS と MASAMUNE-II 利用プロジェクト番号を謝辞に記載する。

---

このページは「MASAMUNE-II のマニュアルを読み始める前に、何を押さえておくと理解しやすいか」を  
コンパクトにまとめたものです。実際に使う際は、必ず公式 User Manual を横に置きながら、  
自分のプロジェクト用のディレクトリ構成・ジョブテンプレートを整備していくとよい。



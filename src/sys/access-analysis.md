# GA4とGTMによるアクセス解析の基礎

GA4（Google Analytics 4）は、サイト上の行動をイベントとして収集し、集計・可視化する解析基盤である。GTM（Google Tag Manager）は、計測タグの配信・管理を集約し、変更を素早く反映させるためのタグ管理基盤である。

## 参考ドキュメント
1. タグ マネージャー ヘルプ：2. ウェブコンテナをインストールする（日本語）
   https://support.google.com/tagmanager/answer/14847097?hl=ja
2. アナリティクス ヘルプ：[GA4] Google アナリティクスのコンバージョンとキーイベントの違い（日本語）
   https://support.google.com/analytics/answer/13965727?hl=ja
3. Google Developers：Consent mode（同意モード）概要（日本語）
   https://developers.google.com/tag-platform/devguides/consent?hl=ja

## 1. 役割の整理（GA4 / GTM / Googleタグ）

### 1.1 GA4（解析・集計の本体）
- 収集したイベントを、ユーザー・セッション・参照元などの軸で集計してレポート化する仕組みである
- 「重要な行動」をキーイベントとして定義し、成果指標として追跡できる

### 1.2 GTM（タグ配信・管理の本体）
- Webサイトの各ページに「コンテナスニペット」を設置し、GTMの画面からタグ（GA4など）を配信する仕組みである
- トリガー（いつ送るか）と変数（値をどう作るか）を組み合わせて、計測の仕様を組み立てる

### 1.3 Googleタグ（送信の共通基盤）
- GA4やGoogle広告などで共通に使われるタグ基盤であり、ブラウザからGoogle側へイベントを送る入口である
- 実装は「サイトへ直接設置」または「GTM経由」が主な選択肢である

## 2. GA4のデータモデル

GA4はイベント中心のデータモデルであり、行動は次の形で表される。

- イベント：名前とパラメータを持つ観測
  - 例：`page_view`（ページ表示）、`scroll`（スクロール）、`purchase`（購入）など
- パラメータ：イベントに付随する属性
  - 例：ページURL、ボタン名、購入金額、商品IDなど

数式で最小表現を置くと、イベント列は次のように見なせる。

$$
\mathcal{D}=\{(t_i,\; e_i,\; \mathbf{p}_i)\}_{i=1}^{N}
$$

- $t_i$：時刻、$e_i$：イベント名、$\mathbf{p}_i$：パラメータ集合である


## 3. GA4の設定（Webサイト構成）

### 3.1 管理画面で行うこと（GA4側）
1. GA4でアカウント／プロパティを用意する
2. データストリーム（Web）を作成する
3. 測定ID（通常 `G-XXXXXXXXXX` 形式）を確認する
4. 拡張計測（Enhanced measurement）を必要に応じて有効化する  
   - スクロール、外部クリック、サイト内検索などを自動イベントとして取得できる

### 3.2 設置方式の選択（2案）
- A案：Googleタグをサイトへ直接設置（改修権限がある場合に明快である）
- B案：GTMでGoogleタグ（GA4）を配信（複数タグ運用や変更頻度が高い場合に有利である）


## 4. GTMの設定（Webコンテナ構成）

### 4.1 GTM側で行うこと
1. GTMでアカウントとコンテナ（Web）を作成する
2. 発行された「2つのコードスニペット」をサイト全ページへ設置する  
   - 1つ目：`<head>` 直後付近  
   - 2つ目：`<body>` 開始直後付近（noscript側）
3. 以後のタグ追加・変更はGTM管理画面で行う

## 5. GTMでGA4計測を動かす（基本）

### 5.1 タグ構成
- Googleタグ（GA4計測用）を作成し、測定IDを紐づける
- 送信条件（トリガー）を「全ページ」などに設定する

この時点で、基本イベント（例：`page_view` など）が入る構成になる。追加の行動（例：ボタンクリック）を測りたい場合、GA4イベントタグを追加して対応する。

### 5.2 「キーイベント」の考え方（GA4）
- 「重要な行動」を測るため、既存イベントまたは新規イベントを用意し、それをキーイベントとしてマークする
- キーイベント化した後、レポート上で成果として追跡できる


## 6. 動作確認

### 6.1 確認に使う画面
| 画面 | 主な役割 | 反映の速さ |
|---|---|---|
| GTMプレビュー（Tag Assistant連携） | タグが発火しているかの確認 | 即時 |
| Tag Assistant | 送信の状態、デバッグ用パラメータ付与など | 即時 |
| GA4 Realtime | 直近のユーザー行動が入っているか | 準即時 |
| GA4 DebugView | デバッグ対象のイベント列を詳細に追跡 | 準即時 |
| 標準レポート/探索 | 集計された分析（遅延あり） | 数時間〜 |

注意として、標準のレポート反映には時間（例：24〜48時間程度）を要する場合があるため、初動はRealtimeとDebugView中心で確かめるのが合理的である。


## 7. 利用方法（GA4の運用）

### 7.1 まず見る指標
- キーイベント率（セッション基準の一例）
$$
r_{key}=\frac{K}{S}
$$
- $K$：キーイベント数、$S$：セッション数である

- エンゲージメント率（GA4の指標として重要である）
$$
ER=\frac{S_{eng}}{S}
$$
- $S_{eng}$：エンゲージメントのあったセッション数、$S$：セッション数である

### 7.2 レポートの見方
1. 集客（参照元・メディア）：流入がどこから来たかを把握する
2. エンゲージメント（ページ・イベント）：サイト内で何が起きているかを把握する
3. キーイベント：成果に結びつく行動の量と経路を把握する
4. 必要に応じて探索（セグメント・経路）：仮説検証の粒度を上げる

### 7.3 イベント設計の基本
- 可能ならGA4の推奨イベント名（例：`purchase`, `generate_lead` など）を優先する  
  - レポートや連携が整備されやすい
- イベント名は命名規則（文字種、予約語、大小区別など）に従う


## 8. 設定の拡張

### 8.1 内部アクセスの除外
- 自組織・自分のアクセスが混入する場合、内部トラフィックとして定義し、データフィルタで除外する考え方がある

### 8.2 データ保持（保持期間の意味）
- GA4では、ユーザー単位の詳細分析（探索など）に保持期間が影響する
- 長期比較が必要なら保持期間を見直す（プロパティ設定で変更する）

### 8.3 同意
- 同意状態（広告・解析ストレージなど）に応じてタグ挙動を制御し、プライバシー要求と計測要求を両立させる枠組みである
- 地域やサイトの要件に応じて、同意管理（CMP等）と整合させる

### 8.4 BigQuery連携（研究用途・高度分析）
- 生データをBigQueryへエクスポートし、SQLで再現性ある集計やモデル化へ進める選択肢がある


## 9. GA4とGTMの比較

| 観点 | GA4 | GTM |
|---|---|---|
| 主機能 | 収集データの集計・可視化・分析 | タグ配信・管理 |
| 扱う対象 | イベント、ユーザー、セッション、参照元など | タグ、トリガー、変数、データレイヤーなど |
| 設置 | Googleタグを設置（直置き/GTM経由） | コンテナスニペット（2つ）を設置 |
| 確認 | Realtime / DebugView | プレビュー（Tag Assistant） |


## まとめと展望
GA4はイベント中心の解析基盤であり、キーイベントの設計によって「何を成果とみなすか」を明確化できる点が本質である。GTMは計測の変更を集約する基盤であり、GA4と組み合わせることで、計測仕様の更新と検証の速度を上げられる構成である。今後は、同意管理の整備、BigQuery連携、サーバーサイド計測などを段階的に取り込み、プライバシー要請と分析の再現性を両立する方向へ発展させるのが有望である。


## 参考文献
- アナリティクス ヘルプ：イベントをキーイベントとしてマークする
  https://support.google.com/analytics/answer/13128484?hl=en
- アナリティクス ヘルプ：推奨イベント（日本語）
  https://support.google.com/analytics/answer/9267735?hl=ja
- アナリティクス ヘルプ：拡張計測イベント
  https://support.google.com/analytics/answer/9216061?hl=en
- アナリティクス ヘルプ：データを収集していることを確認する（Realtime / DebugView）
  https://support.google.com/analytics/answer/9333790?hl=en
- アナリティクス ヘルプ：DebugViewでイベントをモニタする
  https://support.google.com/analytics/answer/7201382?hl=en
- Tag Manager ヘルプ：プレビューとデバッグ（Preview mode）
  https://support.google.com/tagmanager/answer/6107056?hl=en
- Tag Assistant ヘルプ：Tag Assistantでのトラブルシュート
  https://support.google.com/tagassistant/answer/10039345?hl=en
- アナリティクス ヘルプ：データの保持（日本語）
  https://support.google.com/analytics/answer/7667196?hl=ja
- アナリティクス ヘルプ：イベント命名規則
  https://support.google.com/analytics/answer/13316687?hl=en
- タグ マネージャー ヘルプ：Google AnalyticsイベントをTag Managerで設定する
  https://support.google.com/tagmanager/answer/13034206?hl=en

# 磁気弾性連成（磁歪）をFEM弾性ソルバへ

本ページは、マイクロ磁化計算に磁気弾性（磁歪）を組み込むために、磁化 m から固有ひずみを生成し、弾性場を解き、応力・ひずみから磁気側の有効磁場へ返す最小構成を、実装順に整理したものである。計算負荷を抑えるために、連成の更新頻度をスケジューラで制御する設計まで含めて述べる。

## 参考ドキュメント
- COMSOL Blog（日本語）：Modeling Magnetostriction with COMSOL Multiphysics
  https://www.comsol.jp/blogs/modeling-magnetostriction-with-comsol-multiphysics
- MuMax+（arXiv）：The muMax+ micromagnetic simulation engine
  https://arxiv.org/abs/2411.18194
- 杉本 諭（日本語講義資料PDF）：磁歪と磁気異方性（磁気弾性の要点を含む）
  https://www.magnetics.jp/wp-content/uploads/2025/03/6.2Tomographic_Imaging.pdf

## 1. 位置づけと到達目標

3D 線形弾性（Hex8 + 2×2×2 ガウス + SPD CG）を単独で正しく解ける状態があるとする。磁歪がつくる固有ひずみを弾性ソルバへ入力し、弾性解から得られる応力・ひずみによって磁区が変化する往復（双方向）を成立させる。

目標は次の閉ループである。

- 入力：磁化 $m$（空間分布）
- $m$ → 固有ひずみ $ε^0(m)$
- $ε^0(m)$ → 弾性場（$u, ε, σ$）
- $σ$ または $ε$ → 磁気弾性エネルギー密度 $w_{me}$ または等価有効磁場 $H_{me}$
- $H_{me}$ → LLG の有効磁場へ加算 → $m$ が更新

データフロー（概念図）

1) micromag integrator
$$
   H_eff = H_ex + H_ani + H_Z + H_d + H_me + ...
   m_{n+1} = step(m_n, H_eff)
$$
2) coupling.magnetoelastic
   update_if_needed($m_n$) で
     a) $ε^0(m_n)$ を生成
     b) elasticity.solve(..., $ε^0$, bc) で $u, ε, σ$
     c) $σ, m_n$ から $H_{me}$ を生成
   最新の $H_{me}$ フィールドを返す

重要な設計指針は、物理配線の責務を coupling に集約し、micromag/terms 側を薄く保つことである。

## 2. モジュールの分割

### 2.1 coupling/magnetoelastic.py の責務

1. 磁化 $m$ から磁歪固有ひずみ $ε^0(m)$ を生成する
2. elasticity.solve(mesh, C, eps0, bc) を呼び、$u, ε, σ$ を得る
3. 磁気弾性エネルギー（または応力からの等価磁場）を用いて $H_{me}$ を計算する
4. $H_{me}$ を micromag 側へ返す

加えて、計算負荷を抑えるために次を持つべきである。

- キャッシュ：K（大域剛性）や dofmap、境界自由度の分割など、メッシュと材料で不変なものは再利用する
- 更新制御：毎ステップ解かず、スケジュールに基づいて弾性場の更新を間引く

### 2.2 micromag/terms/magnetoelastic.py

- coupling を呼び $H_{me}$ を得るだけ
- エネルギー式や弾性ソルバの詳細、更新頻度、外部領域の扱いは持たない

こうすることで、terms は LLG の項としての薄い実装となり、連成の複雑さは coupling に閉じる。

### 2.3 schedule.py：計算負荷の制御

- demag を何ステップ毎に更新するか
- 弾性場を何ステップ毎に更新するか
を制御する。

スケジュールで可能にしたい運用は次である。

- demag：長距離相互作用で重いので $N_{demag}$ ステップ毎に更新し、間は保持する
- magnetoelastic：弾性 solve が重いので $N_{elastic}$ ステップ毎に更新し、間は $H_{me}$ を保持する


## 3. 磁歪を固有ひずみとして表す

磁気弾性連成の最短経路は、磁歪を固有ひずみ（eigenstrain）として弾性場へ入れ、弾性側はそれをひずみ源として応力を返す形である。

線形弾性の構成則（固有ひずみ付き）

$$
\sigma = C : (\varepsilon - \varepsilon^0).
$$

ここで $ε(u)$ が変位から作る全ひずみ、$ε^0$ が磁歪などの固有ひずみである。

### 3.1 等方近似（多結晶平均）での磁歪固有ひずみ

単軸方向に伸びる等方磁歪を、磁化の単位ベクトル $m = (m_x, m_y, m_z)$ に対して

$$
\varepsilon^0_{ij}(\mathbf{m})
=
\frac{3}{2}\lambda_s \left(m_i m_j - \frac{1}{3}\delta_{ij}\right)
$$

とおくのが代表的な形である。

性質：
- $\mathrm{tr}(ε^0) = 0$ である（体積変化が無い純粋な偏差ひずみ）
- $m$ の向きが変わると $ε^0$ の主軸が回転する
- $λ_s$ が 0 なら固有ひずみは常に 0 となり、連成が退化する

実装上は、各計算セル（またはガウス点）で $m$ を参照し、上式で $ε^0$ を作るだけである。

### 3.2 結晶（立方晶）での磁歪と磁気弾性定数 B1, B2

単結晶を扱う場合、磁歪は結晶座標に依存する。立方晶の代表的な磁気弾性エネルギー密度は、ひずみ $ε$ と方向余弦 $α_i (= m_i)$ を用いて

$$
w_\mathrm{me}
=
B_1(\alpha_x^2\varepsilon_{xx}+\alpha_y^2\varepsilon_{yy}+\alpha_z^2\varepsilon_{zz})
+
2B_2(\alpha_x\alpha_y\varepsilon_{xy}+\alpha_y\alpha_z\varepsilon_{yz}+\alpha_z\alpha_x\varepsilon_{zx})
$$

と表される。

B1, B2 は磁歪定数と弾性定数により結ばれる：

$$
B_1 = -\frac{3}{2}\lambda_{100}(c_{11}-c_{12}),
\qquad
B_2 = -3\lambda_{111}c_{44}.
$$

多結晶・等方近似で十分か、単結晶定数が必要かは、対象（薄膜エピ層、単結晶合金、テクスチャ材）で決めるのが自然である。ここでは等方近似から開始し、必要に応じて B1, B2 形式へ拡張するのが実装上の最短である。

## 4. 弾性ソルバへ固有ひずみを入力する

これまでに確立した枠組みにそのまま載る。

### 4.1 弱形式で見た固有ひずみの入れ方

弱形式（体積力 $b$ と表面力 $t$ を含む）：

$$
\int_{\Omega} \varepsilon(\delta u):C:(\varepsilon(u)-\varepsilon^0)\,dV
=
\int_{\Omega}\delta u\cdot b\,dV+\int_{\Gamma_N}\delta u\cdot t\,dS.
$$

これを離散化すると次になる。

- 左辺：通常の剛性 $K$（$B^T C B$ の要素積分）
- 右辺：固有ひずみがつくる等価節点力 $f^0$

要素 $e$ での固有ひずみ等価力：

$$
f^{0,(e)} = \int_{\Omega_e} B^{T} C\, \varepsilon^{0}\, dV,
$$

したがって大域方程式は

$$
K u = f_\mathrm{ext} + f^0.
$$

$K$ はメッシュと材料 $C$ が固定なら不変である。更新で変わるのは右辺だけである。この事実が計算コスト削減の中心である。

### 4.2 $K$ を固定し、RHS だけ更新する

磁歪連成において、弾性 solve を毎回フルで組み直す必要はない。

推奨手順：
1) 初期化で $K$ を assembly し、Dirichlet 消去により $K_{ff}$ を作りキャッシュする
2) 各更新で $ε^0$ をガウス点で評価し、$f^0$ を assembly して $f_{ff}$ を作る
3) $K_{ff} u_f = f_{ff}$ を CG で解く（前回解を初期値にすると収束が早くなる）
4) $u$ から $ε$ と $σ$ を評価し、必要な形（セル中心へ平均、もしくはガウス点保持）で保持する

これにより、メッシュが大きいほど効果が出る。

### 4.3 ひずみ・応力の評価点（ガウス点かセル中心か）

磁気側がセル中心の $m$ を使う場合に、弾性側の $σ$ をどこで持つかは設計選択である。

代表的な選択肢：
- ガウス点で $σ$ を持つ（要素内で最も自然で、エネルギー整合性が高い）
- 要素平均を取り、セル中心へ投影した $σ$ を持つ（磁気と同じ格子で扱いやすい）
- 節点へ外挿して持つ（後処理や可視化には便利だが、外挿はノイズ源になり得る）

実装では、ガウス点で $σ$ を計算し、セルへ平均して $H_{me}$ を作る流儀が実装容易である。

## 5. 応力・ひずみから磁気側の有効磁場 $H_{me}$ を作る

LLG に足すべきはエネルギーから定まる有効磁場である。一般に

$$
\mathbf{H}_\mathrm{me}
=
-\frac{1}{\mu_0 M_s}\frac{\delta W_\mathrm{me}}{\delta \mathbf{m}}
$$

で与えられる。ここで $W_{me}$ は磁気弾性エネルギーである。

### 5.1 応力を使う最短式（等方磁歪）

等方固有ひずみモデルを用いる場合、磁気弾性エネルギー密度は

$$
w_\mathrm{me} = -\sigma : \varepsilon^0(\mathbf{m})
$$

と書ける。$\mathrm{tr}(ε^0)=0$ であるため、実質は偏差応力が効く形になる。

応力の偏差成分：

$$
\sigma_\mathrm{dev} = \sigma - \frac{1}{3}\mathrm{tr}(\sigma)\,I.
$$

このとき

$$
w_\mathrm{me}
=
-\frac{3}{2}\lambda_s\, \mathbf{m}\cdot \sigma_\mathrm{dev}\cdot \mathbf{m}.
$$

したがって有効磁場は

$$
\mathbf{H}_\mathrm{me}
=
\frac{3\lambda_s}{\mu_0 M_s}\,\sigma_\mathrm{dev}\,\mathbf{m}.
$$

ここで重要なのは、静水圧（$\mathrm{tr}(\sigma)$）だけが乗った応力は $\sigma_\mathrm{dev}=0$ となり、磁化方向を選好しないため $H_{me}$ に寄与しないことである。実装で $\mathrm{tr}(\sigma)$ を引き忘れると、非物理な等方応力が磁化を駆動し得るため注意が必要である。

### 5.2 ひずみを使う表現（立方晶 B1, B2 形式）

立方晶の $w_{me}$ を用いる場合、$w_{me}(ε, m)$ を $m$ で偏微分すれば $H_{me}$ が得られる。

例として上の

$$
w_\mathrm{me}( \varepsilon, \mathbf{m})
=
B_1\sum_i \alpha_i^2 \varepsilon_{ii}
+
2B_2\sum_{i<j}\alpha_i\alpha_j \varepsilon_{ij}
$$

に対し、

$$
\mathbf{H}_\mathrm{me}
=
-\frac{1}{\mu_0 M_s}\frac{\partial w_\mathrm{me}}{\partial \mathbf{m}}
$$

を用いて成分ごとに実装する。B1, B2 形式は結晶方向の取り扱い（座標回転）が必ず必要になるため、等方式で往復の枠組みをまず固め、次段階で導入するのが安全である。

### 5.3 エネルギー整合性

磁気弾性は符号を取り違えやすい。最低限の自己診断を入れる。

- $w_{me}$ を明示的に計算し、期待する極小方向へ $m$ が回るかを見る
- $λ_s$ の符号を変えると、選好方向が反転するはずである
- $λ_s=0$ で $H_{me}=0$ になり、弾性 solve を行っても磁気側の時間発展が変わらないことを確認する

## 6. 連成更新のスケジューリング

弾性 solve は demag と同程度かそれ以上に重いことがある。 ここでは、毎ステップ更新しない運用を設計の中心に置く。

### 6.1 何を間引くか

- demag：長距離相互作用で高コスト
- elasticity：固有ひずみが生む応力場の solve が高コスト

よって schedule.py は少なくとも次を持つとよい。

- update_demag_every = N_demag
- update_elastic_every = N_elastic

### 6.2 間引きの理屈（準静的近似）

弾性波を解くのではなく準静的に釣り合いを満たす $u$ を求める場合、磁化が十分ゆっくり変わる（あるいは応力場が磁化変化に対して滑らかに追随する）範囲では、$H_{me}$ を数ステップ保持しても大きく崩れにくい。

ただし、以下のケースでは更新を細かくする必要がある場合がある。

- 大きな $λ_s$、強いクランプ、急峻な磁壁運動
- パルス磁場などで $m$ が急変する条件
- 低減衰で前進積分の安定性が厳しい条件

### 6.3 ステップ数と閾値のハイブリッド

固定周期だけでなく、磁化の変化量で弾性更新をトリガするのが有効である。

例：
- i が $N_{elastic}$ の倍数なら更新する
- それ以外でも $max|m - m_last| > δm$ なら更新する

m の変化が小さいときは弾性を維持し、変化が大きいときだけ追随させる形になる。

### 6.4 速度最適化の定番

- $K_{ff}$ は固定なので、前処理（Jacobi でもよい）を固定化できる
- 前回の $u$ を初期値として CG を回すと反復回数が減りやすい
- $ε^0$ による等価力 assembly をベクトル化し、要素ループの定数部分（$B^T C, detJ$, 重み）を事前計算して持つ
- σ をガウス点で計算し、最終的に $H_{me}$ をセル中心へ平均する

## 7. 境界条件と領域の扱い

### 7.1 代表的な機械境界条件

- 自由表面：$σ n = 0$（Neumann）
- クランプ：$u = 0$（Dirichlet）
- 基板拘束：下面を固定、上面自由、側面はケースにより自由

薄膜・基板系では拘束が強く、磁歪が応力として蓄積しやすい。結果として $H_{me}$ が強くなり、磁区が大幅に変わることがある。これは物理的であるが、境界条件の意図が不明確だと解釈不能になるため、bc はパラメータとして必ず明示する。

### 7.2 領域分割（磁性と非磁性）

弾性は、磁性領域だけを解く近似も可能だが、基板やバッファを含めた複合領域として解く方が現実に近い場合がある。

設計方針：
- 磁性領域のみで解き、機械境界条件で拘束を表現する
- 基板を含む複合弾性領域を組み、磁性領域にだけ ε^0 を与える

coupling 層で領域の切り分けを持たせ、terms は領域を意識しない形が保守性が高い。

## 8. テスト設計

ここでの合格基準は、数値的に動くことではなく、退化と整合性が取れていることに置く。

### 8.1 退化テスト（磁歪ゼロ）

- $λ_s = 0$ とすると $ε^0 = 0$、したがって $H_{me} = 0$ となる
- このとき磁気計算は、磁気弾性項を追加していない場合と一致するべきである

### 8.2 連成の健全性（磁歪強度の掃引）

- $λ_s$ を増やすと、応力分布が増大し、それに応じて磁区（例えば磁壁位置、磁化の傾き）が変化する
- 変化の方向性が $w_{me}$ の極小化と整合していることを確認する

### 8.3 更新頻度の頑健性（準静的近似の確認）

- 毎ステップ更新と、数ステップ毎更新で結果が大きく崩れないこと
- 崩れる場合は、更新頻度が粗すぎる、または磁化変化が急すぎる可能性がある
- 閾値トリガ（$δm$）を入れると改善する場合がある

### 8.4 エネルギーの整合チェック

磁気弾性エネルギーを別途モニタする。

- $w_{me}(x)$ の空間分布
- $W_{me} = ∫ w_{me} dV$ の時間変化
- 総エネルギー（磁気＋弾性）の符号や発散の有無

符号や係数の間違いはここで露呈しやすい。

## 9. 注意点

- 単位の不整合：$σ$（Pa）、$λ$（無次元）、$Ms$（A/m）、$μ_0$ を含む係数の桁を再確認する
- 応力の定義点：セル中心とガウス点の混在で $H_{me}$ がノイジーになる（平均化やスムージングの設計が必要）
- 静水圧成分を引かない：磁化方向を選好しない等方応力が駆動力になる誤りを生む
- 固定しすぎる BC：全方向拘束は剛体モードは消えるが、物理として過拘束になり得る
- 連成の強さが過大：$λ_s$ を実材料より大きく入れると、時間積分の安定性が崩れやすい

## 10. 次の拡張への見通し

拡張は配線を壊さずに追加できる。

- 結晶磁気弾性（B1, B2 と座標回転）
- 異方弾性（C を一般 6×6 として扱う）
- 線形粘弾性や減衰を含む準静的モデル（応力緩和）
- 弾性波を含む動的連成（elastodynamics + LLG の完全連成）
- 熱（温度ひずみ $ε^T$）やランダム熱場の導入

## まとめ

磁気弾性（磁歪）をマイクロ磁化計算へ組み込む最短経路は、$m$ から固有ひずみ $ε^0(m)$ を生成し、弾性ソルバで応力場を得て、応力から等価有効磁場 $H_{me}$ を作って LLG へ返す往復をまず成立させることである。計算の重さは弾性 solve と長距離相互作用の更新が支配するため、coupling に責務を集約し、schedule で更新頻度を制御し、退化テストと更新頻度テストで準静的近似の妥当性を確認できれば、以後の結晶磁気弾性や多物理場拡張へ安全に進める状態になる。

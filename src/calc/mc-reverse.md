# リバースモンテカルロ（RMC）法入門

リバースモンテカルロ（Reverse Monte Carlo, RMC）法は、回折・全散乱などの実験データを最もよく再現するように、多数原子の3次元配置を確率的に更新して得る構造モデリング手法である。周期性の強い結晶からガラス・液体・ナノ不均質系まで、平均構造だけでは届きにくい短距離秩序を原子配置として扱える点が核である。

## 参考ドキュメント
1. R. L. McGreevy, L. Pusztai, Reverse Monte Carlo Simulation: A New Technique for the Determination of Disordered Structures, Molecular Simulation (1988)  
   https://tothgergely.web.elte.hu/szammod/RMC_McGreevyPusztai_1988.pdf
2. RMCProfile7: reverse Monte Carlo for multiphase systems, Journal of Applied Crystallography (2024)  
   https://journals.iucr.org/j/issues/2024/04/00/yr5127/yr5127.pdf
3. X線散乱パターンを用いたPDF解析〜理論と実際〜（RIGAKU JOURNAL, 日本語, RMC の位置づけを含む）  
   https://resources.rigaku.com/hubfs/2024%20Rigaku%20Global%20Site/Resource%20Hub/Knowledge%20Library/Rigaku%20Journals/Japanese/50%E5%B7%BB1%E5%8F%B7%E9%80%9A%E5%B7%BB111%E5%8F%B7%EF%BC%882019%E5%B9%B44%E6%9C%88%EF%BC%89/rigaku-jounal_50-1_1-8.pdf


## 1. RMC とは何か：Forward と Reverse の違い

### 1.1 Forward モデリング（通常のシミュレーション）
分子動力学（MD）や通常のモンテカルロ（MC）では、相互作用ポテンシャル（エネルギー関数）を与え、統計力学に従って構造や物性を生成する。すなわち
- 入力：ポテンシャル、温度、圧力、組成
- 出力：原子配置のアンサンブル、相関関数、拡散、揺らぎ

である。観測量（散乱強度など）は、得られた配置から計算して実験と比較する。

### 1.2 Reverse モデリング（RMC の考え方）
RMC はこの流れを反転し、実験データを最優先の拘束として原子配置を更新する。すなわち
- 入力：実験データ（例：$S(Q)$、$F(Q)$、PDF $G(r)$、Bragg 強度、EXAFS など）と最低限の幾何制約
- 出力：入力データと整合する原子配置（多原子スーパーセル）

である。RMC は「力学的にそのまま時間発展させる」手法ではなく、「観測量に整合する構造の集合」を探索する手法である。


## 2. 全散乱データと、RMC が合わせにいく量

### 2.1 散乱ベクトルと構造因子の基本
散乱ベクトルの大きさを
$$
Q = \frac{4\pi}{\lambda}\sin\theta
$$
とする。ここで $\lambda$ は波長、$2\theta$ は散乱角である。

等方系（粉末・アモルファス・液体）では、測定から得られる代表量として構造因子 $S(Q)$ がある。しばしば
$$
F(Q) = Q\left[S(Q)-1\right]
$$
も用いられる。

### 2.2 ペア分布関数（PDF）とフーリエ関係
全散乱で得た $S(Q)$ または $F(Q)$ から、実空間の PDF を得る基本関係は
$$
G(r)=\frac{2}{\pi}\int_{0}^{Q_{\max}} Q\left[S(Q)-1\right]\sin(Qr)\,dQ
$$
である（慣習により $G(r)$、$D(r)$、$T(r)$ などの定義は流儀がある）。

また、動径分布関数 $g(r)$（正規化された2体相関）との関係は密度 $\rho_0$ を用いて
$$
G(r)=4\pi r\rho_0\left[g(r)-1\right]
$$
のように書かれることが多い（定義により係数が変わるので、使用ソフトの定義に合わせるのが重要である）。

### 2.3 多成分系：部分相関の重み付け
多成分系では、観測される $S(Q)$ や PDF は、部分相関 $g_{\alpha\beta}(r)$ の重み付き和として現れる。例えば中性子散乱では散乱長 $b_\alpha$ を用いて重みが決まるため、元素コントラスト（同位体置換も含む）が構造分離に効く。


## 3. RMC の数理：目的関数、受理確率、制約の入れ方

### 3.1 目的関数（ミスフィット）の基本形
実験データ $D^{\mathrm{exp}}$ と、原子配置から計算した $D^{\mathrm{calc}}$ の差を、重み付き最小二乗で評価するのが基本である。複数データセット $d$ を同時に使う場合、
$$
\chi^2
= \sum_{d} w_d \sum_{i}
\left(
\frac{D_{d,i}^{\mathrm{calc}}-D_{d,i}^{\mathrm{exp}}}{\sigma_{d,i}}
\right)^2
$$
とする。ここで $\sigma_{d,i}$ は実験誤差（または実効誤差）、$w_d$ はデータセット間の重みである。

RMC はしばしば「データに合わせること」を第一にするため、$w_d$ の選び方は解の形に直結する。特に Bragg（長距離秩序）と PDF（短距離秩序）を同時に合わせる場合、どちらを優先するかで最終モデルが変わりうる。

### 3.2 幾何制約・物理制約を入れる一般形
最小距離制約や配位制約などを、罰則項として足し合わせることが多い。
$$
\Phi = \chi^2 + \sum_k \lambda_k P_k
$$
- $P_k$：制約違反の量（例：許容距離より短い原子対の数、特定配位数からのずれ、分子の剛体制約の破れなど）
- $\lambda_k$：制約の強さ

制約は「追加情報」であり、入れ方が強すぎるとデータ一致は良くてもモデルの自由度が不自然に固定される。逆に弱すぎると、データ一致は達成しても化学的に不自然な近接や配位が残る。

### 3.3 受理確率（Metropolis 型）
原子をランダムに動かす提案（move）を行い、目的関数の変化 $\Delta \Phi$ に応じて受理・棄却する。基本形は
$$
p_{\mathrm{acc}}=\min\left[1,\exp\left(-\frac{\Delta\Phi}{2}\right)\right]
$$
のような形である（係数や温度パラメータの付け方は実装により異なる）。
- $\Delta\Phi<0$（改善）なら高確率で受理
- $\Delta\Phi>0$（改悪）でも一定確率で受理し、局所解への固定を避ける

RMC が MC でありつつ「エネルギー」ではなく「データミスフィット」を最小化している点が決定的に特殊である。


## 4. アルゴリズムの流れ

1. 初期構造の用意  
   結晶なら平均構造をスーパーセル化し、非晶質ならランダム充填（所望密度）や MD 生成ガラスを初期配置にする。

2. 観測量の計算  
   原子配置から $S(Q)$、$F(Q)$、$G(r)$、Bragg 強度、EXAFS など対象データに対応する計算量を得る。

3. 原子の移動提案  
   1原子（または分子・剛体単位）をランダムに微小変位させる。多成分系では元素交換（swap）を許す場合もある（化学秩序の探索に効く）。

4. 目的関数の更新と受理判定  
   差分更新が可能な量は差分で高速化し、$\Delta\Phi$ により受理・棄却を決める。

5. 反復と収束判定  
   $\chi^2$ や各データセットの残差が十分に下がり、かつ制約違反が抑えられたところで停止する。統計的な意味での安定化を確認するため、停止後も一定ステップ回してアンサンブルを抽出することもある。


## 5. RMC モデルから取り出す構造量

RMC の出力は「原子配置（大きな箱）」であるため、実験データの一次元量からは直接得にくい多様な統計量が計算できる。

- 部分 RDF/PDF：$g_{\alpha\beta}(r)$
- 配位数：
  $$
  N_{\alpha\beta}(r_c)=4\pi\rho_\beta\int_{0}^{r_c} r^2 g_{\alpha\beta}(r)\,dr
  $$
  （$r_c$ は第1殻のカットオフ）
- 結合角分布、四面体性（$Q$ パラメータなど）、リング統計（ネットワークガラス）
- 局所密度ゆらぎ、空隙分布（Voronoi 解析）
- 化学短距離秩序（Warren–Cowley パラメータなど、合金系）

RMC は「データ整合な構造の一例」を返すのではなく、「データ整合な構造の集合（アンサンブル）」の代表を与えると捉えると理解が安定する。


## 6. RMC の強みと限界

### 6.1 強み
- 実験データ駆動であり、短距離秩序を原子配置として持てる
- ガラス・液体・欠陥・局所歪み・ナノ不均質など、単純な平均構造記述を超える対象に機能する
- 複数データ（X線＋中性子、$S(Q)$＋PDF、Bragg＋散漫散乱など）を同時に扱える実装が整っている

### 6.2 限界（基本的な数学構造）
RMC は一般に「与えられた実験データから一意に構造が決まる」ことを保証しない。理由は明快である。

- 観測量（例：$S(Q)$ や PDF）は 1次元の平均量であり、3次元の原子配置に比べ情報が少ない
- 多成分系では部分相関が重み付きで混ざり、分離が難しい
- 有限の $Q_{\max}$ や分解能により、短距離の鋭い特徴が丸められる

したがって、RMC の信頼性は「どれだけ独立な情報を追加できるか」「どれだけ妥当な制約を入れられるか」に依存する。


## 7. 制約の設計

RMC で頻用される制約の例を挙げる。

- 最小距離制約（hard-sphere cutoff）  
  原子半径に基づき、$r<r_{\min}$ の原子対を禁止する。最も基本で、非物理的な原子重なりを強く抑える。

- 配位数制約  
  既知の局所構造（例：SiO$_2$ の Si–O が4配位など）を反映する。ただし固定しすぎると新しい局所欠陥を排除するため、幅を持たせることが多い。

- 角度・多体制約  
  ネットワークガラスや分子系では結合角が本質であり、角度分布をゆるく拘束する。

- 分子剛体・柔軟制約  
  分子液体や有機電解質では、分子内距離・角度を保つ必要がある。柔軟拘束（harmonic 罰則）を入れる実装もある。

- ポテンシャル併用（RMC with potentials）  
  データ一致だけでなく、ポテンシャルエネルギーを補助的に入れる方式がある。実装の一例が RMC_POT であり、分子の柔軟拘束や非結合相互作用を取り込む設計がされている。

制約は「データと独立な先験情報」であるため、何をどの強さで入れたかを明示し、制約を変えたときに得られる構造量がどの程度揺らぐかを把握する姿勢が重要である。


## 8. 全散乱解析の中での RMC

全散乱（total scattering）解析には大きく二つの方向がある。

- 小箱（small-box）  
  少数原子の構造パラメータ（格子定数、原子座標、熱振動など）を最適化して PDF を合わせる。平均構造のパラメトリック表現に強い。

- 大箱（big-box）  
  1万原子規模以上の配置を動かしてデータに合わせる。局所歪みや無秩序を粒度よく持てる。RMC はこの代表である。

比較を表にまとめる。

| 観点 | 小箱（パラメータフィット） | 大箱（RMC） |
|---|---|---|
| 表現 | 少数パラメータで平均構造を表す | 多数原子の配置そのもの |
| 得意 | 結晶の平均構造、平均歪み | 局所歪み、無秩序、欠陥、短距離秩序 |
| データ | PDF、Bragg を統合しやすい | PDF、$S(Q)$、Bragg、複数実験の同時合わせが可能 |
| 注意点 | 局所無秩序の表現が制限される | 非一意性が出やすく制約設計が重要 |


## 9. 代表的ソフトウェアと特徴

- RMCProfile / RMCProfile7  
  全散乱データ、Bragg、PDF を含めて扱う「big-box」RMC の代表格であり、多相系同時フィットなどの機能拡張が進んでいる。  
  公式: https://rmcprofile.org/

- RMC++  
  RMC の基本実装として広く使われてきた系統である。  
  公式: https://www.szfki.hu/~nphys/rmc++/downloads.html

- RMC_POT  
  分子の柔軟拘束やポテンシャル併用を視野に入れた実装である。分子液体・分子性ガラスなどで「データには合うが化学的に不自然」になりやすい問題への対応として位置づけられる。

ソフトの選択は、対象が
- 無機ネットワーク（ガラス、アモルファス合金）
- 多相（結晶＋アモルファス、粒界、析出）
- 分子液体・溶液・電解質
のどれに近いかで大きく変わる。


## 10. 実験データ側の要点：$Q_{\max}$ と多重データの効き方

RMC の精度と安定性は、実験データの情報量に強く依存する。特に PDF では $Q_{\max}$ が実空間分解能を支配し、有限の $Q_{\max}$ による終端効果が $G(r)$ の振動として現れる。

概念的には、$Q_{\max}$ が大きいほど短距離のピークが鋭くなり、RMC が許される構造の自由度が絞られる。逆に $Q_{\max}$ が小さい場合、異なる3次元配置でも類似の $G(r)$ を与えやすく、非一意性が増える。

多成分系や複雑系では
- 中性子＋放射光 X 線の同時使用（重みが異なる）
- $S(Q)$ と PDF の同時使用（同じ情報の二重化ではなく、フィルタの違いとして効く）
- Bragg＋散漫散乱＋PDF の同時使用（長距離と短距離を両立）
がモデルを強く拘束する方向に働く。


## 11. 研究例

- ネットワークガラス（SiO$_2$、酸化物ガラスなど）  
  配位・角度・リング統計が重要であり、RMC による 3D モデルが局所秩序の可視化に直結する。

- 金属ガラス・アモルファス合金  
  近接原子配置と化学短距離秩序（CSRO）が鍵であり、PDF とRMC の組合せが広く使われる。

- 溶液・電解質・細孔内流体  
  分子内拘束を持つ分子系では、RMC_POT のような分子拘束・ポテンシャル併用が選択肢になる。

- 多相・ナノ不均質  
  平均構造の重ね合わせでは表現しにくい局所歪みや界面構造を、大箱モデルとして扱える。


## まとめ

RMC 法は、全散乱やPDFなどの実験データに整合するように原子配置を確率的に更新し、局所構造を3次元の原子モデルとして扱う方法である。非一意性という基本的制約を持つ一方で、複数データの同時使用と妥当な制約設計により、ガラス・液体・アモルファス合金・多相系の短距離秩序を定量的に議論できる強力な枠組みになる。


## 関連研究

- O. Gereben, L. Pusztai, RMC_POT: reverse Monte Carlo with potentials for molecular systems, Journal of Computational Chemistry (2012)  
  https://onlinelibrary.wiley.com/doi/abs/10.1002/jcc.23058

- O. Gereben, Determination of the atomic structure of disordered systems on the basis of diffraction data: principles and application of RMC, Phys. Rev. B (1995)  
  https://link.aps.org/doi/10.1103/PhysRevB.51.5768

- JAEA Review (2008): RMCProfile: Studying Disorder in Crystalline Materials  
  https://jopss.jaea.go.jp/pdfdata/JAEA-Review-2008-031-04.pdf

- 日本結晶学会誌（2009）PDF 法構造解析（RMC 言及を含む、日本語）  
  https://www.jstage.jst.go.jp/article/jcrsj/51/1/51_1_79/_pdf

# モンテカルロ計算の原理
作成日：2025年11月23日

## 概要
- モンテカルロ法（Monte Carlo method）は、**乱数サンプリングを用いて、期待値・積分・確率分布・物理量を数値的に求める手法**。
- 「解析的に計算できない（あるいは非常に難しい）量」を、大量のランダムサンプルによる統計平均として近似するのが基本思想。
- 応用例：
  - 高次元積分の評価（路積分、配位空間積分など）
  - 統計力学（イジング模型、スピングラス、格子モデル）
  - ベイズ統計・機械学習（MCMC）
  - 金融工学（オプション価格評価、リスク評価）

## 基本アイデア：確率変数の期待値として計算する
- ある物理量 \(A\) が、確率分布 \(p(x)\) に従う変数 \(x\) の関数 \(A(x)\) の期待値として書けるとする：
  \[
    \langle A \rangle = \int A(x)\,p(x)\,dx
  \]
- 解析的に積分できない場合、
  - \(p(x)\) に従って乱数サンプル \(\{x_i\}_{i=1}^N\) を生成し、
  - 次のように標本平均で近似する：
  \[
    \langle A \rangle \approx \frac{1}{N}\sum_{i=1}^N A(x_i)
  \]
- サンプル数 \(N\) を増やすことで、統計誤差は概ね \(1/\sqrt{N}\) のオーダーで減少する（中心極限定理）。

## 統計力学におけるモンテカルロ法
- カノニカル分布（NVT）の例：
  - 配位 \(\{x\}\) の確率密度：
    \[
      p(x) \propto e^{-\beta E(x)} \quad (\beta = 1/k_BT)
    \]
  - ここで \(E(x)\) はエネルギー、\(T\) は温度。
- 物理量 \(A\) の熱力学平均：
  \[
    \langle A \rangle = \frac{\int A(x)\,e^{-\beta E(x)} dx}{\int e^{-\beta E(x)} dx}
  \]
- 高次元（多数の粒子）のため、積分は解析的に不可能 →  
  **「Boltzmann 重み \(e^{-\beta E}\) に従うサンプルを生成」し、その上での平均として評価する**。

## マルコフ連鎖モンテカルロ（MCMC）の原理
- 高次元空間で「任意分布 \(p(x)\) に従う乱数」を直接生成するのは難しいことが多い。
- そこで **マルコフ連鎖 (Markov chain)** を構成し、連鎖の定常分布が目的の \(p(x)\) になるように設計する。
- 代表例：メトロポリス法（Metropolis 法）
  1. 今の状態を \(x\) とする。
  2. 遷移分布 \(q(x \to x')\) に従って「候補」状態 \(x'\) を提案。
  3. 受容確率
     \[
       P_{\text{acc}} = \min\left(1,\ \frac{p(x')\,q(x'\to x)}{p(x)\,q(x\to x')}\right)
     \]
     に従って、\(x'\) を「採択（受容）」するか「却下（元の \(x\) に留まる）」か決める。
  4. このステップを繰り返すことで、長時間後には状態の出現頻度が分布 \(p(x)\) に従うようになる。
- イジング模型・ハイゼンベルク模型などでは、
  - スピン反転（単スピンフリップ）やクラスター更新（Swendsen–Wang, Wolff）など、物理に即した遷移則が用いられる。

## 擬似乱数とサンプリング
- モンテカルロ法では、計算機上で生成した **擬似乱数列** を使用する。
- よく使われる手法：
  - 線形合同法、Mersenne Twister などの擬似乱数生成器
  - 連続一様分布乱数から、逆変換法・棄却法・Box–Muller 法などで他の分布へ変換
- 高次元・長時間のシミュレーションでは、乱数の質（周期、相関）が結果に影響しうるため、信頼性の高い乱数生成器が望ましい。

## 誤差評価と収束
- モンテカルロ推定値の誤差：
  - サンプルが独立なら標準偏差は
    \[
      \sigma_A \approx \sqrt{\frac{\text{Var}(A)}{N}}
    \]
  - MCMC のように自己相関がある場合は、有効サンプル数 \(N_{\text{eff}} < N\) となる。
- 実務上のポイント：
  - 「熱化（burn-in）」：連鎖の初期部分は捨てる。
  - 「自己相関の評価」：ブロック平均や自己相関関数から、実効自由度を見積もる。
  - 「パラメータ依存性」：系サイズ・温度・更新アルゴリズムによる収束性（臨界スローイングダウンなど）を確認。

## モンテカルロ法の利点
- 高次元でも適用可能：
  - 次元が大きくなると通常の数値積分（格子積分）が爆発的に重くなるのに対し、モンテカルロ法の誤差は主に \(1/\sqrt{N}\) に支配され、次元依存が弱い。
- 汎用性：
  - 積分・最適化・サンプリング・ベイズ推論・物理シミュレーションなど、多用途。
- 実装の柔軟性：
  - 「モデルのエネルギー（評価関数）さえ計算できればよい」ため、アルゴリズム自体は比較的シンプル。

## モンテカルロ法の限界・注意点
- 収束性の問題：
  - サンプル数 \(N\) を増やすほど計算コストも線形に増大。
  - 相関の強い系・低温・臨界点近傍では「なかなか状態が変わらない」＝自己相関が長くなり、統計効率が悪化。
- 系のエルゴード性：
  - 遷移ルールの設計が悪いと、状態空間の一部しか探索できず、真の分布に到達しない場合がある。
- 結果の検証：
  - 別温度・別サイズ・別アルゴリズムで再計算し、一貫性や有限サイズスケーリングを確認することが重要。


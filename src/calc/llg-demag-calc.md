# 反磁界（長距離相互作用）の数値解法：畳み込み・Poisson解法・境界要素法の整理

反磁界（demagnetizing field, stray field）は磁化分布全体に依存するため、マイクロ磁化計算において計算量と精度を最も支配しやすい項である。本稿では、方程式の定式化から、代表的な高速計算法（FFT畳み込み、FEM/BEM、FMMなど）と境界条件の扱いを体系的に整理する。

## 参考ドキュメント
- A. Vansteenkiste et al., The design and verification of MuMax3, AIP Advances 4, 107133 (2014)
  https://pubs.aip.org/aip/adv/article-pdf/doi/10.1063/1.4899186/12878560/107133_1_online.pdf
- K. M. Lebecki et al., Periodic boundary conditions for demagnetization interactions in micromagnetic simulations (OOMMF related)
  https://math.nist.gov/~MDonahue/pubs/pbc-in-oommf_4.6.pdf
- 日本磁気学会スクール資料：マイクロマグネティックス（講義資料）
  https://www.magnetics.jp/archive/seminar/school/ss_034/ss_034_matsuyama.pdf

## 1. 反磁界の基礎式（磁静力学）
磁化 $M(r)$ が与えられたとき、磁静力学では

- $∇×H = 0$
- $∇·B = 0$
- $B = μ0(H + M)$

が成り立つ。$∇×H = 0$ よりスカラー磁位 $φ$ を用いて $H = -∇φ$ と書けるので、

$$
\nabla \cdot \mathbf{H} = -\nabla\cdot\mathbf{M}
\quad\Rightarrow\quad
\nabla^2 \phi = \nabla\cdot\mathbf{M}
$$

となる（符号や定義は流儀があるため、式を導出して整合させることが重要である）。

反磁界 $Hd$ は通常、磁性体内部での反磁界として
$$
\mathbf{H}_d(\mathbf{r}) = \mathbf{H}(\mathbf{r}) - \mathbf{H}_\mathrm{ext}(\mathbf{r})
$$
などと扱われ、LLGの実効磁界 $Heff$ の主要項として毎ステップ計算される。

### 磁荷（magnetic charge）による直感
磁化の発散が体積磁荷、表面法線成分が表面磁荷として振る舞うと見なすと、

- 体積磁荷密度 $ρm = -∇·M$
- 表面磁荷密度 $σm = M·n$

を用いて磁位を積分表示できる。これにより、反磁界が本質的に長距離（$1/r^2$）で結合する理由が明確になる。

## 2. 離散化の基本：反磁界はテンソル畳み込みになる
有限差分（直交格子）では、セル $i$ の平均磁化 $Mi$ からセル中心の反磁界 $Hdi$ を求める離散化がよく用いられる。

$$
\mathbf{H}_{d,i} = -\sum_j \mathbf{N}_{i-j}\,\mathbf{M}_j
$$

ここで N は 3×3 の離散反磁界テンソル（demagnetizing tensor kernel）であり、相対位置 (i-j) のみに依存する（平行移動不変性）。この構造が高速化の鍵となる。

重要な設計点は次である。
- セル内磁化を一様とみなす近似（piecewise constant）か、平均場として扱うか
- セル中心で評価するか、セル平均として評価するか
- 形状境界が階段状（staircase）になる誤差をどう扱うか

## 3. FFTによる高速畳み込み（finite-difference micromagnetics の標準）
### 3.1 直接計算の計算量と、FFT化の狙い
上式をそのまま計算すると、Nセルに対して O(N^2) となり、大規模系で破綻する。畳み込み定理を使えば

- 反磁界テンソル N のフーリエ変換 𝓕[N]
- 磁化 M のフーリエ変換 𝓕[M]

から、周波数空間で点ごとの積を取り、逆変換することで

$$
\mathbf{H}_d = -\mathcal{F}^{-1}\{\mathcal{F}[\mathbf{N}] \cdot \mathcal{F}[\mathbf{M}]\}
$$

を O(N log N) で評価できる。

### 3.2 畳み込みカーネル（離散反磁界テンソル）の作り方
直交格子上で「一様に磁化した直方体セル同士の相互作用」を厳密積分した式を用いて N を構成する方法が広く使われる。
このとき N は対称性を持ち、自己項（同一セル）と近距離項の扱いが精度を左右する。

運用上の要点は次である。
- N は最初に一度だけ計算し、以後は再利用する
- 形状が固定なら N は固定でよい（外場掃引や時間発展でも不変）
- 複数材料（Msが空間変化）では、M = Ms m として M を更新しつつ同じ N を使うのが基本になる

### 3.3 無限空間（開境界）をFFTで扱う：ゼロパディング
FFTは本質的に周期畳み込みを計算するため、そのままだと“折り返し相互作用”が混入する。無限空間に近い開境界を近似するには、計算領域外をゼロ磁化で埋めるパディングを行い、循環畳み込みが実質的に線形畳み込みになるようにする。

典型的には
- 各方向でサイズを2倍程度に拡張（2Nx, 2Ny, 2Nz）
- 域外は M=0 として埋める
- 逆FFT後に元の領域だけ切り出す

という操作を行う。パディング量が少ないと、境界近傍で反磁界が歪む。

### 3.4 周期境界条件（PBC）とEwald的扱い
薄膜の2次元周期、バルクの3次元周期など、周期境界条件を課したい場合は、カーネル N 自体を周期和した形に置き換える必要がある。単純なゼロパディングではなく、

- PBCに対応する反磁界テンソル N_PBC を構成する
- その上でFFT畳み込みを行う

という流れになる。2D周期（面内周期）では特に、真空層の取り方や実効的な遠方境界の扱いが結果に影響する。

### 3.5 多層膜・スピントロニクス構造：multilayer convolution
多層膜を一様格子で全空間離散化すると、非磁性スペーサや真空層のために無駄なセルが増えやすい。層方向を不等間隔に扱いつつ、面内はFFT畳み込みで高速化する「多層畳み込み」は、薄膜多層系で計算効率を改善する発想である。

## 4. FEM（有限要素法）によるPoisson/Laplace解法
有限要素法では、複雑形状・曲面境界・多結晶形状に対して幾何近似誤差を抑えやすい。一方で、反磁界は“外部無限空間”を含むため、境界条件の置き方が本質的となる。

代表的な定式化は次のいずれかである。
- スカラー磁位 φ による定式化（H = -∇φ）
- ベクトルポテンシャル A による定式化（B = ∇×A など）

スカラー磁位を用いる場合、磁性体内部では Poisson、外部では Laplace を解き、界面での連続条件を満たす必要がある。外部無限領域は、巨大な空気領域を置く、無限要素（infinite element）を使う、境界条件を工夫するなどの方法で近似される。

## 5. BEM（境界要素法）とFEM/BEMハイブリッド
反磁界問題の難点は外部の無限領域である。境界要素法（BEM）は外部領域を境界積分に落とし込めるため、無限空間に自然に対応できる。

ただしBEMは密行列になりやすく計算量が重い（O(N^2) になりやすい）。そこで実装としては
- 内部をFEM、外部をBEMで扱うハイブリッド
- BEM行列の高速化（FMMやH行列）
などが採用されることがある。

形状が複雑で、反磁界が支配的（永久磁石、磁性粒子集合、微細加工構造）な問題では、有力な選択肢となる。

## 6. FMM（高速多重極法）・階層法によるO(N)近似
磁荷（または双極子）相互作用を遠方では多重極展開でまとめて近似し、近傍のみを直接計算することで O(N) あるいは O(N log N) を目指すのがFMM系の発想である。

概略は次である。
- 空間を階層的に分割（木構造）
- 遠方セル群の寄与を多重極展開で集約
- 近傍セルは直接和で計算
- 精度パラメータ（展開次数、近傍範囲）で誤差と計算量を制御

FFT法が直交格子に強いのに対し、FMMは点群・不規則配置・適応メッシュとも相性がよい。ただし実装の複雑さと定数項が大きい点が課題となりやすい。

## 7. 精度検証の観点（反磁界特有のチェック項目）
反磁界は長距離相互作用ゆえに、わずかな境界・カーネル誤差が全体に波及する。代表的な検証観点は次である。

### 7.1 解析解・既知解との比較
- 一様磁化楕円体の反磁界（反磁界係数が一様）
- 薄膜の近似式（面内・面外磁化での極限挙動）
- 標準問題（μMAGなど）でのエネルギー比較

### 7.2 エネルギーの整合性
反磁界エネルギーは

$$
E_d = -\frac{\mu_0}{2}\int_\Omega \mathbf{M}\cdot \mathbf{H}_d\, dV
$$

の形で評価されることが多い。時間発展でエネルギーが不自然に増減する場合、時間積分の問題だけでなく反磁界計算のラップアラウンドや単位系混在も疑うべきである。

### 7.3 メッシュ依存性と境界依存性
- セルサイズを変えたときに、反磁界エネルギーが収束するか
- パディング量を増やしたときに、境界近傍の反磁界が安定するか
- PBCの有無で、期待する極限（薄膜、バルク）へ向かうか

## 8. 計算量の目安と選択ガイド
| 手法 | 典型の計算量 | 強い状況 | 注意点 |
|---|---:|---|---|
| 直接和 | O(N^2) | ごく小規模、検証用 | 大規模では不可 |
| FFT畳み込み（FD） | O(N log N) | 直交格子、大規模、GPU | 開境界はパディング、形状は階段誤差 |
| FEM（Poisson/Laplace） | 反復解法に依存 | 複雑形状、曲面、局所改良 | 外部無限領域処理が要点 |
| BEM / FEM-BEM | 問題依存（重め） | 無限領域を厳密に扱いたい | 密行列の高速化が必要 |
| FMM / 階層法 | O(N)〜O(N log N) | 不規則配置、適応メッシュ | 実装が難しく定数項が大きいことがある |
| 多層畳み込み | O(N log N)系 | 薄膜多層、スペーサが多い系 | 近似条件と実装依存がある |

## 9. 実装と再現性のためのチェックリスト
- 単位系：M（A/m）、H（A/m）、B（T）、エネルギー密度（J/m^3）を混在させない
- カーネル定義：Nの自己項、対称性、セル中心/セル平均の定義を明示する
- 境界条件：開境界（パディング量）とPBC（周期次元）を明示する
- 検証：一様磁化形状、μMAG標準問題、格子収束で最低限の整合性を確認する
- 形状誤差：階段近似が支配的な場合、FEMや補正の導入を検討する


## まとめ
反磁界は磁化分布の全セル間結合として現れ、計算コストと境界条件の扱いが結果の信頼性を左右する。直交格子では離散反磁界テンソルのFFT畳み込みが標準であり、開境界ならパディング、周期系ならPBC対応カーネルが要点となる。複雑形状や無限領域の厳密性が重要な場合はFEM/BEMや階層法が有効であり、解析解・標準問題・格子収束による検証を通じて反磁界計算の妥当性を担保する必要がある。

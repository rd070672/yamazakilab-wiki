# MCMC 計算の原理と計算例
作成日：2025年11月23日

## 概要
- MCMC（Markov Chain Monte Carlo）は、**マルコフ連鎖を使って「狙った確率分布」からサンプルを生成する方法**。
- 目的：
  - 直接サンプリングが難しい分布 \(p(x)\)（例：高次元ベイズ事後分布、統計力学のボルツマン分布）から
  - 連鎖の長時間平均として期待値 \(\langle A(x) \rangle\) を評価する。
- 特徴：
  - 次元が高くても適用可能。
  - 「エネルギー」や「対数尤度」が計算できればよい（正規化定数は不要）。

---

## MCMC の基本原理

### 1. マルコフ連鎖
- 状態 \(x_0, x_1, x_2, \dots\) が次のルールで更新されるとする：
  - \(\Pr(x_{n+1} \mid x_n, x_{n-1},\dots) = \Pr(x_{n+1} \mid x_n)\)
  - これがマルコフ性（直前の状態だけに依存）。
- 遷移確率（カーネル）を \(T(x \to x')\) と書く。

### 2. 定常分布と詳細釣り合い
- 連鎖が十分長く続くと、**状態の出現頻度がある分布 \(\pi(x)\)** に近づく。
- MCMC では、この定常分布が「狙った分布」 \(p(x)\) になるように \(T\) を設計する。
- よく使う条件：
  - **詳細釣り合い（detailed balance）**
    \[
      p(x)\,T(x \to x') = p(x')\,T(x' \to x)
    \]
  - これを満たすように遷移確率を作ると、\(p(x)\) が定常分布になる。

### 3. 期待値の評価
- 連鎖から得たサンプル \(\{x_n\}_{n=1}^N\) を用いて、
  \[
    \langle A \rangle \approx \frac{1}{N}\sum_{n=1}^N A(x_n)
  \]
- 初期状態の影響を避けるため、**burn-in（熱化）期間** のサンプルは捨てるのが一般的。

---

## 代表的なアルゴリズム

### Metropolis–Hastings 法
- 目標分布：\(p(x)\)（正規化定数は不明でもよい）。
- 遷移手順：
  1. 現在の状態を \(x\) とする。
  2. 提案分布 \(q(x \to x')\) に従い、新しい候補 \(x'\) を生成。
  3. 受容確率
     \[
       \alpha(x \to x') =
       \min\left(1,\ \frac{p(x')\,q(x' \to x)}{p(x)\,q(x \to x')}\right)
     \]
     を計算。
  4. 一様乱数 \(u \sim U(0,1)\) を引き、\(u < \alpha\) なら \(x' \) を受容（次の状態にする）、  
     そうでなければ拒否して \(x\) にとどまる。
- 特に
  - 提案分布が対称（例：ガウス \(q(x \to x') = q(x' \to x)\)）なら
    \[
      \alpha(x \to x') = \min\left(1,\ \frac{p(x')}{p(x)}\right)
    \]
    と簡単になる。

### Gibbs サンプリング（簡単なイメージ）
- 多変量 \(x = (x_1,\dots,x_d)\) の場合、
  - 条件付き分布 \(p(x_i \mid x_{\setminus i})\) を順番にサンプルしていく方法。
- 1 ステップ：
  1. \(x_1 \sim p(x_1 \mid x_2^{(n)}, \dots, x_d^{(n)})\)
  2. \(x_2 \sim p(x_2 \mid x_1^{(n+1)}, x_3^{(n)}, \dots)\)
  3. …
- 条件付き分布が解析的にサンプリングできるときに非常に効率的。

---

## 計算例：1 次元分布 \(p(x) \propto \exp(-x^4 + x^2)\) のサンプリング

### 1. 目標分布の設定
- 解析的に正規化しにくいが、形は簡単な 1 次元分布：
  \[
    p(x) \propto \exp(-x^4 + x^2)
  \]
- 「二重井戸に少し似た」ポテンシャルを持つ例として使える。

### 2. Metropolis–Hastings によるサンプリング手順
- 初期状態：\(x_0 = 0\) など適当な値。
- 提案分布：  
  - 例：ガウス提案 \(x' = x + \eta\), \(\eta \sim \mathcal{N}(0, \sigma^2)\)
- 1 ステップ：
  1. 現在 \(x\)。
  2. \(\eta\) をガウス乱数から生成し、候補 \(x' = x + \eta\) を作る。
  3. 目標分布の比：
     \[
       r = \frac{p(x')}{p(x)} = 
       \exp\big[ -(x'^4 - x^4) + (x'^2 - x^2) \big]
     \]
  4. 受容確率 \(\alpha = \min(1, r)\) を計算。
  5. 一様乱数 \(u\) を引き、
     - \(u < \alpha\) なら \(x_{n+1} = x'\)（受容）
     - それ以外なら \(x_{n+1} = x\)（拒否）
- このステップを繰り返すことで、\(\{x_n\}\) は次第に \(p(x)\) に従うサンプル列になっていく。

### 3. 結果の利用
- burn-in（例：最初の 5000 ステップ）を捨てる。
- その後のサンプル \(\{x_n\}\) から：
  - 平均値 \(\langle x \rangle\)、二乗平均 \(\langle x^2 \rangle\)
  - 分散、尖度、ヒストグラム（≒分布形状）
  を評価できる。
- 例えば：
  - ヒストグラムが \(\exp(-x^4 + x^2)\) に比例した形状になっているかチェック。
  - 自己相関関数 \(\rho(k)\) を計算して、どのくらいステップ間に相関が残っているかを見る。

---

## 計算例：2 次元ガウス分布の Gibbs サンプリング（イメージ）

### 1. 目標分布
- 2 次元ガウス：
  \[
    p(x,y) \sim \mathcal{N}(\boldsymbol{\mu}, \Sigma)
  \]
  - 例えば相関のある分布（共分散行列 \(\Sigma\) が非対角）。

### 2. 条件付き分布
- 多変量ガウスの性質から、
  - \(p(x \mid y)\)、\(p(y \mid x)\) は 1 次元ガウスになり、平均・分散を解析的に書ける。

### 3. Gibbs サンプリング
- 手順：
  1. 初期状態 \((x_0, y_0)\) を決める。
  2. \(x_{n+1} \sim p(x \mid y_n)\) をガウス乱数で生成。
  3. \(y_{n+1} \sim p(y \mid x_{n+1})\) をガウス乱数で生成。
  4. 2–3 を繰り返す。
- 結果：
  - \(\{(x_n,y_n)\}\) は目的の 2 次元ガウス分布に従うサンプルとなる。
  - 散布図は「楕円状」のクラウドになり、共分散構造を反映する。

---

## MCMC 実務上のポイント（共通）

- **burn-in の長さ**  
  - 初期値依存性が消えるまで、ある程度のステップを破棄する。
- **提案分布のスケール調整**（Metropolis）
  - ステップが小さすぎる → 受容率は高いが移動距離が小さく、強く相関。  
  - 大きすぎる → 受容率が低下し、ほとんど跳ばない。  
  - 実務上は、受容率 20–50% 程度がよいと言われることが多い。
- **自己相関と有効サンプル数**
  - サンプル間の自己相関が大きいと、実効自由度が減る。  
  - ブロック平均や自己相関時間から有効サンプル数を見積もる。
- **収束診断**
  - 初期値を変えた複数チェーンの比較（Gelman–Rubin 統計など）。
  - 物理量の時間シリーズがある程度「定常」に見えているか確認。
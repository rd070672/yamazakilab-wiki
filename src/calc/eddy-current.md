# LLG方程式にもとづくマイクロ磁化シミュレーション入門（連続体近似・数値離散化・検証）

マイクロ磁化シミュレーションは、磁化ベクトル場の時間発展をLLG方程式で追跡し、磁区・磁壁・渦構造・スピンダイナミクスを定量化する手法である。材料定数と形状・欠陥・界面効果を入力として、ヒステリシス、共鳴、デピニングなどの現象を同一の方程式系で扱える点が核となる。

## 参考ドキュメント
- Vansteenkiste et al., The design and verification of MuMax3, AIP Advances 4, 107133 (2014)
  https://pubs.aip.org/aip/adv/article/4/10/107133/584191/The-design-and-verification-of-MuMax3
- NIST, OOMMF User’s Guide（公開ドキュメント）
  https://math.nist.gov/oommf/doc/userguide21a0/userguidexml/userguide.html
- 田中智大, 大規模マイクロマグネティックシミュレーションを用いた永久磁石…, まてりあ/関連誌（J-STAGE, 2023）
  https://www.jstage.jst.go.jp/article/jinstmet/87/5/87_JA202203/_html/-char/ja

## 1. マイクロ磁気学（micromagnetics）の前提
### 1.1 連続体近似
原子スピンを直接扱うのではなく、空間座標 r と時刻 t に依存する磁化
$ \mathbf{M}(\mathbf{r},t)$ を連続場として扱う近似である。通常、飽和磁化 $M_s$ を用いて
$\mathbf{m}=\mathbf{M}/M_s$ と正規化し、$|\mathbf{m}|=1$ を拘束条件として課す。

この近似が成立するためには、セルサイズ（空間離散化の最小単位）が交換相互作用で決まる代表長さ（交換長）より十分小さいことが望ましい。

### 1.2 何を予測する計算か
- 磁区・磁壁・渦（vortex）・スキルミオンなどの準静的構造（平衡解）
- 外部磁場・電流・温度ゆらぎ下での動的応答（歳差運動、緩和、反転、共鳴）
- 形状（反磁界）や界面（DMI、界面異方性）による有効磁気異方性の出現
- 多結晶・欠陥・粒界を含むモデルにおける局所的な反転核生成やデピニング

## 2. LLG方程式：歳差運動と減衰
### 2.1 Gilbert形（標準的な記法）
代表的な形は次である。

$$
\frac{d\mathbf{m}}{dt}
= -\gamma\,\mu_0\, \mathbf{m}\times \mathbf{H}_\mathrm{eff}
+ \alpha\, \mathbf{m}\times \frac{d\mathbf{m}}{dt}
$$

- $\gamma$：ジャイロ磁気比（符号規約に注意が必要である）
- $\mu_0$：真空透磁率
- $\alpha$：Gilbert減衰定数（無次元）
- $\mathbf{H}_\mathrm{eff}$：実効磁界（有効磁界）

数値積分では、右辺に $d\mathbf{m}/dt$ が含まれるため、陽的に解いた形（Landau–Lifshitz形に等価変形した形）を使うことが多い。

### 2.2 Landau–Lifshitz形（陽的に書く例）
Gilbert形を代数的に整理すると、（規約に依存するが）概念的には

$$
\frac{d\mathbf{m}}{dt}
= -\frac{\gamma\mu_0}{1+\alpha^2}\left[
\mathbf{m}\times \mathbf{H}_\mathrm{eff}
+ \alpha\, \mathbf{m}\times(\mathbf{m}\times \mathbf{H}_\mathrm{eff})
\right]
$$

となり、第一項が歳差運動、第二項がエネルギーを減らす向きの緩和（減衰）を表す。

### 2.3 重要な制約：$|\mathbf{m}|=1$
LLGの連続方程式は本質的に磁化の大きさを保存するが、数値積分では誤差により $|\mathbf{m}|$ がずれる。多くの実装は
- $|\mathbf{m}|$ の正規化（renormalization）
- 球面上の幾何学的積分（制約付き積分）
により制約の破れを抑制する。

## 3. 実効磁界：エネルギー汎関数からの導出
マイクロ磁気学では、実効磁界は全エネルギー汎関数 $E[\mathbf{m}]$ の汎関数微分として与えられる。

$$
\mathbf{H}_\mathrm{eff}(\mathbf{r})
= -\frac{1}{\mu_0 M_s}\frac{\delta E}{\delta \mathbf{m}(\mathbf{r})}
$$

よって、どの物理を入れるかは $E$ の項の選択に対応する。

## 4. エネルギー項の典型と式
以下では代表的な項を列挙する。離散化と境界条件によって表式や係数の扱いが変わるため、実装ごとの定義確認が必要である。

### 4.1 交換エネルギー（exchange）
$$
E_\mathrm{ex}
= \int_\Omega A\,|\nabla \mathbf{m}|^2\, dV
$$
- $A$：交換剛性
局所的に磁化が急激に変化するとエネルギーが増えるため、磁壁幅や渦芯サイズを決める主因である。

### 4.2 結晶磁気異方性（magnetocrystalline anisotropy）
一軸異方性の例：
$$
E_\mathrm{ani}
= \int_\Omega K_u\,\left(1-(\mathbf{m}\cdot \mathbf{e}_u)^2\right)\, dV
$$
- $K_u$：一軸異方性定数
- $\mathbf{e}_u$：易磁化軸方向

立方異方性、面内異方性、界面異方性などへ拡張される。

### 4.3 ゼーマンエネルギー（外部磁場）
$$
E_\mathrm{Z}
= -\mu_0 M_s \int_\Omega \mathbf{H}_\mathrm{ext}\cdot \mathbf{m}\, dV
$$

### 4.4 静磁エネルギー（反磁界・磁化自己相互作用）
$$
E_\mathrm{d}
= -\frac{\mu_0 M_s}{2} \int_\Omega \mathbf{H}_\mathrm{d}\cdot \mathbf{m}\, dV
$$
反磁界 $\mathbf{H}_\mathrm{d}$ は磁化分布全体に依存する長距離相互作用であり、計算コストと境界処理を支配する。有限差分では畳み込みをFFTで高速化する実装が多い。

### 4.5 DMI（Dzyaloshinskii–Moriya interaction）
界面DMIの一例（表式は規約が複数ある）：
$$
E_\mathrm{DMI}
= \int_\Omega D\left[
m_z(\nabla\cdot \mathbf{m})-(\mathbf{m}\cdot\nabla)m_z
\right] dV
$$
- $D$：DMI定数
Néel型スキルミオンやキラル磁壁の安定化に関与する。

### 4.6 磁歪・磁気弾性（magnetoelastic）
応力場やひずみ場と結合する形で
$$
E_\mathrm{me}=\int_\Omega f(\mathbf{m},\varepsilon_{ij})\,dV
$$
と書かれ、弾性場（力学）とLLGを連成させると、磁区形成と応力の相互作用を扱える。連成の仕方は解析目的に強く依存する。

## 5. 代表長さとメッシュ設計：交換長・磁壁幅
### 5.1 交換長（exchange length）
典型的には磁化の空間変化と静磁相互作用の競合から交換長 $l_\mathrm{ex}$ を定義する。

$$
l_\mathrm{ex}=\sqrt{\frac{2A}{\mu_0 M_s^2}}
$$

この長さスケール程度で磁化は滑らかに変化するため、セルサイズ $\Delta$ は
$\Delta \lesssim l_\mathrm{ex}$（より保守的には $l_\mathrm{ex}/2$ 程度）
を目安として設定されることが多い。

### 5.2 形状表現と離散化手法の選択
| 方式 | 代表例 | 長所 | 注意点 |
|---|---|---|---|
| 有限差分（直交格子） | OOMMF, MuMax3 | FFTによる反磁界高速化、実装が比較的単純 | 曲面・複雑形状の表現が格子に制限される |
| 有限要素（非構造格子） | 各種FEMコード | 複雑形状・曲面・多結晶形状に強い | 反磁界計算・メッシュ生成・計算コストが重くなりやすい |

## 6. 時間積分（ODEとしてのLLG）と数値安定性
### 6.1 LLGは剛性を持ちうる
交換項は空間高周波成分（短波長）に強く働くため、細かいメッシュほど時間積分が剛性化しやすい。剛性が強い場合、陽的スキームでの安定条件が厳しくなる。

### 6.2 代表的な積分戦略
- 陽的Runge–Kutta系（実装容易、安定条件が支配的）
- 半陰/陰的手法（剛性への耐性、各ステップで反復解法が必要なことがある）
- 適応刻み（局所誤差制御により、歳差運動が激しい領域で刻みを自動縮小する）

### 6.3 平衡状態の計算（静的問題への落とし込み）
LLGの高減衰（大きな $\alpha$）で緩和させる方法は、エネルギー最小化の近似として使われることがある。一方で、より直接に
- エネルギー勾配に基づく最適化
- 非線形共役勾配法
などで平衡解を求める流れもある（目的が準静的磁化過程である場合に相性がよい）。

## 7. 熱ゆらぎ（stochastic LLG）
有限温度では、熱揺らぎをランダム磁界 $\mathbf{H}_\mathrm{th}$ として実効磁界に加える。

$$
\mathbf{H}_\mathrm{eff}\rightarrow \mathbf{H}_\mathrm{eff}+\mathbf{H}_\mathrm{th}(t)
$$

連続時間では白色雑音として相関
$$
\langle H_{\mathrm{th},i}(t)\,H_{\mathrm{th},j}(t')\rangle
\propto \delta_{ij}\delta(t-t')
$$
を持つよう設定され、離散時間ではセル体積 $V$ と時間刻み $\Delta t$ に依存した分散で乱数を生成する。温度を入れる計算では、時間刻み依存性や統計量の収束（アンサンブル平均）が重要になる。

## 8. 電流・スピントルク項（拡張LLG）
磁性体への電流注入やスピン流により、追加トルク項を含む拡張LLGが用いられる。

### 8.1 Zhang–Li型（移流形）
$$
\left.\frac{d\mathbf{m}}{dt}\right|_\mathrm{STT}
= -(\mathbf{u}\cdot\nabla)\mathbf{m}
+ \beta\,\mathbf{m}\times(\mathbf{u}\cdot\nabla)\mathbf{m}
$$
- $\mathbf{u}$：スピンドリフト速度（電流密度や分極率に依存）
- $\beta$：非断熱パラメータ

### 8.2 Slonczewski型（固定分極方向 p を仮定）
$$
\left.\frac{d\mathbf{m}}{dt}\right|_\mathrm{SOT/STT}
= a_J\,\mathbf{m}\times(\mathbf{m}\times\mathbf{p})
+ b_J\,\mathbf{m}\times\mathbf{p}
$$
界面スピン軌道トルク（SOT）では、有効分極方向の取り方や電流分布モデルが鍵になる。

## 9. 反磁界計算と境界条件
### 9.1 反磁界（長距離相互作用）の計算
反磁界はポアソン型問題や畳み込みとして表現され、有限差分ではFFT畳み込みで高速化されることが多い。周期境界条件（PBC）を入れる場合、反磁界の取り扱いが変わるため、実装が想定する“周期性”の次元（1D/2D/3D周期）を確認する必要がある。

### 9.2 境界条件の例
- 交換境界：自由境界（法線方向勾配ゼロ）や固定境界（表面スピン固定）
- DMI境界：界面DMIでは自然境界条件が磁壁の巻き方に影響する
- 磁性/非磁性界面：$M_s$ や $A$ の不連続をどう扱うか（格子・要素の物性割当て）が重要である

## 10. 出力と解析：何を見ればよいか
### 10.1 典型出力
- $\mathbf{m}(\mathbf{r},t)$ のスナップショット、動画
- 全磁化 $\langle \mathbf{M}\rangle(t)$ とヒステリシス $M(H)$
- エネルギー各項 $E_\mathrm{ex},E_\mathrm{ani},E_\mathrm{d},E_\mathrm{Z},...$ の時間変化
- トポロジカル量（スキルミオン数など、定義は離散化に依存）

### 10.2 周波数解析（共鳴・スピン波）
パルス磁場を与えて $\langle m_x\rangle(t)$ を取得し、FFTでスペクトルを得ると、FMRやモード分解が可能である。空間FFTと組み合わせると分散関係の推定もできる。

## 11. 検証（verification）と比較：標準問題の役割
マイクロ磁化コードは、反磁界・交換・境界条件・時間積分など複数要素が絡むため、既知の標準問題での検証が重要である。

- μMAG標準問題：同一の幾何・材料定数・磁場条件に対し、複数コードで時系列や最終状態を比較する枠組みである
- 標準問題#4：薄膜長方形の反転ダイナミクスを比較する動的問題であり、時間発展の差が出やすい

数値条件（セルサイズ、時間刻み、収束判定）により結果が変わりうるため、再現性のための条件記録が必須である。

## 12. 代表的ソフトウェア群と位置づけ
| ソフトウェア | 離散化 | 特徴 | 向きやすい題材 |
|---|---|---|---|
| OOMMF | 有限差分 | 公開ドキュメントが充実、古典的ベンチマークが多い | 基本検証、標準問題、2D/薄膜系 |
| MuMax3 | 有限差分（GPU） | GPU+FFTで大規模・高速、動的問題に強い | 大面積薄膜、スキルミオン、SOT/STT、時間発展 |
| FEM系コード | 有限要素 | 曲面・複雑形状・多結晶形状への適合 | 永久磁石粒界、複雑形状デバイス |

国内文献でも、差分法としてOOMMFやMuMax系、有限要素法として各種CAEが言及されており、目的に応じた選択が推奨される。

## 13. 典型ワークフロー（考え方の順序）
1. 目的の明確化（準静的か動的か、熱ゆらぎや電流を入れるか）
2. 形状とスケール設定（厚さ、エッジ、粒界、欠陥、周期性）
3. 材料パラメータ設定（$M_s,A,K,\alpha$、必要ならDMI・界面異方性・交換結合など）
4. メッシュ設計（交換長に基づくセルサイズ、形状表現の妥当性）
5. 初期状態の生成（飽和状態、ランダム、既知磁区からの緩和）
6. 緩和計算（平衡状態の取得）と、その後の外場掃引・パルス印加・電流印加
7. 可視化と診断（エネルギー収支、磁化保存、反転経路、統計量）
8. 標準問題や他コードとの比較による検証

## 14. 典型的な落とし穴
- セルサイズが大きすぎて磁壁が解像できない（見かけ上のピン止めが発生する）
- 単位系の混在（A/m、T、J/m3、erg/cm3など）
- 反磁界の境界条件（PBCの次元、自由空間の扱い）を誤る
- 時間刻みが粗く、歳差運動が数値的に過減衰・過振動になる
- 減衰定数を目的（準静的/動的）に合わない値で固定し、解釈が揺れる
- 温度項を入れたのにアンサンブル平均を取らず、単一軌道で議論する

## まとめ
LLG方程式にもとづくマイクロ磁化シミュレーションは、エネルギー汎関数から実効磁界を導き、磁化ベクトル場の拘束つき時間発展として解く枠組みである。計算の成否は、エネルギー項の選択、交換長にもとづくメッシュ設計、反磁界計算、時間積分の安定性、標準問題による検証という一連の整合性に依存する。

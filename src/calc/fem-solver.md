# 3次元線形弾性のHex8有限要素ソルバ

本ページは、3次元弾性体の変位場 u を有限要素法（FEM）で解くために、どの数式をどの順に実装すると「弾性だけ」が正しく動くかを、一般の読者にも追える形でまとめたものである。対象は小変形の線形弾性であり、Hex8（8節点六面体一次要素）＋ 2×2×2 ガウス積分 ＋ 疎行列CGにより、変位・ひずみ・応力・弾性エネルギーを得る枠組みを説明する。

## 参考ドキュメント
- Ref1: J. R. Shewchuk, An Introduction to the Conjugate Gradient Method Without the Agonizing Pain (1994)
- Ref2: 東京大学の講義資料：FEMにおける要素とガウス積分（六面体8節点要素を含む）
- Ref3: 日本機械学会 機械工学事典：六面体要素

## 1. 何を計算したいのか

目的は、与えた境界条件と材料定数のもとで、弾性体内部の

- 変位 $u(x) = (u_x, u_y, u_z)$
- ひずみ $ε(x)$
- 応力 $σ(x)$
- 弾性エネルギー $U$

を一貫して計算できる状態を作ることである。将来的に磁気弾性（磁歪）を入れる場合も、まず弾性単独が正しいことを保証しておくと、以後のバグ切り分けが劇的に楽になる。

入力（代表例）
- 形状とメッシュ（格子数 $Nx,Ny,Nz$、セルサイズ dx,dy,dz）
- 材料定数（等方：ヤング率 $E$ とポアソン比 $ν$、またはラメ定数 $λ$, $μ$）
- 境界条件（変位指定のDirichlet、または表面力のNeumann）
- 固有ひずみ $ε^{0}$（最初は $0$。磁歪では $ε^{0}(m)$ を入れる）

出力
- 節点変位ベクトル $u$（自由度は各節点3成分）
- 要素内（ガウス点）での $ε$, $σ$
- 総弾性エネルギー $U ≥ 0$（基本チェック）

## 2. 連続体の基礎式：線形弾性

小変形・準静的（慣性無視）とする。すると支配方程式は次である。

(1) つり合い（体積力 $b$、境界表面力 $t$ がある場合）
$$
\nabla \cdot \sigma + b = 0 \quad \text{in } \Omega,
$$
$$
\sigma n = t \quad \text{on } \Gamma_{N},
\qquad
u = \bar{u} \quad \text{on } \Gamma_{D}.
$$

(2) ひずみ–変位関係（小ひずみ）
$$
\varepsilon(u) = \frac{1}{2}\left(\nabla u + (\nabla u)^{T}\right).
$$

(3) 構成則（フック則）
固有ひずみ $ε^{0}$ を含めると
$$
\sigma = C : (\varepsilon - \varepsilon^{0}).
$$
等方弾性なら
$$
\sigma = 2\mu(\varepsilon-\varepsilon^{0}) + \lambda \, \mathrm{tr}(\varepsilon-\varepsilon^{0}) I,
$$
ここでラメ定数は
$$
\mu = \frac{E}{2(1+\nu)}, \qquad
\lambda = \frac{E\nu}{(1+\nu)(1-2\nu)}.
$$

## 3. 弱形式

FEMは、微分方程式をそのまま差分化するのではなく、「仮想仕事の原理（弱形式）」に落としてから離散化する。

仮想変位 $δu$ を用い、体積力 $b$ と表面力 $t$ を含む場合の弱形式は
$$
\int_{\Omega} \varepsilon(\delta u) : \sigma(u)\, dV
=
\int_{\Omega} \delta u \cdot b \, dV
+
\int_{\Gamma_N} \delta u \cdot t\, dS.
$$

固有ひずみがあると左辺に $σ = C:(ε-ε^{0})$ が入るので、$ε^{0}$ の寄与は「等価節点力」に変換される（後述）。

この弱形式を、要素ごとの積分（ガウス求積）で数値計算し、全要素を足し合わせて大域方程式にする。

## 4. 離散化の形：$u(x)$ を節点値で近似する

要素 $e$ 内での変位近似を
$$
u^{(e)}(x) \approx \sum_{a=1}^{8} N_a(\xi,\eta,\zeta)\, u_a
$$
と置く。ここで $N_a$ は形状関数、$u_a$ は節点 $a$ の変位（3成分ベクトル）である。

すると、要素のひずみは
$$
\varepsilon^{(e)} = B^{(e)} u^{(e)}_{\mathrm{nodal}}
$$
と書ける。$B$ はいわゆる $B$ 行列（ひずみ–変位行列）で、形状関数の空間微分から作る。

最終的に大域方程式は
$$
K u = f
$$
という疎行列の連立一次方程式に落ちる。

## 5. Hex8（8節点六面体一次要素）とは

Hex8は、立方体を基準要素（自然座標）に写像して扱う「アイソパラメトリック要素」の代表である。一般的に一次の3次元要素としてもっとも広く使われる形の一つである。

自然座標 $(ξ,η,ζ) ∈ [-1,1]^3$ を用いる。8節点の局所座標は各軸で ±1 の組で表される。節点 $a$ の符号を $(ξ_a, η_a, ζ_a) ∈ {±1}^3$ とすると、形状関数は

$$
N_a(\xi,\eta,\zeta)
=
\frac{1}{8}(1+\xi\,\xi_a)(1+\eta\,\eta_a)(1+\zeta\,\zeta_a).
$$

幾何も同じ形状関数で近似する（アイソパラメトリック）：
$$
x(\xi,\eta,\zeta) \approx \sum_{a=1}^{8} N_a(\xi,\eta,\zeta)\, x_a.
$$

これによりヤコビアン
$$
J = \frac{\partial x}{\partial (\xi,\eta,\zeta)}
$$
が得られ、自然座標微分から実座標微分への変換は
$$
\nabla N_a = J^{-T} \nabla_{\xi} N_a
$$
で与えられる。

## 6. 2×2×2 ガウス求積（要素積分の基本）

要素剛性は
$$
K^{(e)}
=
\int_{\Omega_e} B^{T} C B \, dV
$$
で定義されるが、一般に解析積分はせず数値積分を使う。Hex8一次要素では $2×2×2$ のガウス点（計8点）を使うのが標準的であり、基礎教材でもこの形が説明される。

自然座標で
$$
\int_{\Omega_e} (\cdot)\, dV
=
\int_{-1}^{1}\int_{-1}^{1}\int_{-1}^{1} (\cdot)\, \det(J)\, d\xi\, d\eta\, d\zeta
$$
なので、ガウス点 g で
$$
K^{(e)} \approx \sum_{g=1}^{8} B_g^{T} C B_g \, \det(J_g)\, w_g
$$
となる。ここで $w_g$ はガウス重みである（2点則なら各軸の重みは 1）。この式が hex8_shape.py（形状関数・勾配・$J$）と quadrature.py（点と重み）の中心である。

## 7. B行列とボイグト表記

3Dの小ひずみテンソルは
$$
\varepsilon =
\begin{pmatrix}
\varepsilon_{xx} & \varepsilon_{xy} & \varepsilon_{xz}\\
\varepsilon_{yx} & \varepsilon_{yy} & \varepsilon_{yz}\\
\varepsilon_{zx} & \varepsilon_{zy} & \varepsilon_{zz}
\end{pmatrix},
\quad
\varepsilon_{xy}=\varepsilon_{yx},\ \text{etc.}
$$

実装では 6成分のベクトル（ボイグト）に並べることが多い：
$$
\varepsilon_v = 
(\varepsilon_{xx},\varepsilon_{yy},\varepsilon_{zz},
\gamma_{xy},\gamma_{yz},\gamma_{zx})^{T},
$$
ここで工学せん断ひずみを
$$
\gamma_{xy}=2\varepsilon_{xy},\quad \gamma_{yz}=2\varepsilon_{yz},\quad \gamma_{zx}=2\varepsilon_{zx}
$$
と置く流儀にすると、C行列（等方）は定番の形になる。

B行列は「形状関数の実空間微分 $∂N/∂x, ∂N/∂y, ∂N/∂z$ を節点ごとに並べる」ことで作れる。節点 $a$ に対して

- $u_x$ の係数に $∂N_a/∂x$ が入るのが $ε_{xx}$
- $u_y$ の係数に $∂N_a/∂y$ が入るのが $ε_{yy}$
- $u_z$ の係数に $∂N_a/∂z$ が入るのが $ε_{zz}$
- $γ_{xy}$ は $∂N_a/∂y$（$u_x$側）と $∂N_a/∂x$（$u_y$側）の和
- 同様に $γ_{yz}$, $γ_{zx}$

という規則で構成される。

## 8. 要素剛性から大域剛性へ

各要素の局所自由度は 8節点×3成分=24自由度である。局所剛性 $K^{(e)}$ は 24×24 行列になる。

dofmap.py は
- 要素 $e$ の節点番号（8個）
- それぞれの（節点, 成分）を大域自由度番号に写す

という写像を提供する。assembly.py は
$$
K[I,J] \mathrel{+}= K^{(e)}[i,j]
$$
を全要素で行い、大域疎行列 $K$ を構築する。

この時点で $K$ は対称であり、境界条件を適切に処理すれば（剛体モードを除去できれば）正定値（SPD）になる。

## 9. Dirichlet境界条件の適用

変位を指定する境界 $Γ_D$ では
$$
u = \bar{u}
$$
を強制する必要がある。数値的に重要なのは、剛性行列のSPD性を壊さずに処理することである。代表的な手法は「消去法」で、固定自由度を未知変数から外す。

自由度を
- 自由（free）: $u_f$
- 固定（fixed）: $u_d = \bar{u}_d$

に分けると
$$
\begin{pmatrix}
K_{ff} & K_{fd}\\
K_{df} & K_{dd}
\end{pmatrix}
\begin{pmatrix}
u_f\\
u_d
\end{pmatrix}
=
\begin{pmatrix}
f_f\\
f_d
\end{pmatrix}
$$

より
$$
K_{ff} u_f = f_f - K_{fd} u_d
$$
に落ちる。これを解いてから $u_d$ を戻せばよい。bc.py の中心はここである。

この方法をきちんと入れると、全固定や片面固定などでも剛体モードによる発散が起きにくくなる。

## 10. ソルバ：自前CG（共役勾配法）とJacobi前処理

大域方程式 $K u = f$ の K は巨大・疎であるため、直接法（LU分解）より反復法が適する場面が多い。特に $K$ が対称正定値（SPD）であれば、共役勾配法（CG）が定番である（Ref1）。

CGは残差 $r_k = f - K u_k$ を用い、二次形式（エネルギー）
$$
\Phi(u) = \frac{1}{2}u^{T}Ku - u^{T}f
$$
を最小化する観点でも理解できる。停止判定は例えば
$$
\frac{\|r_k\|}{\|r_0\|} < \mathrm{tol}
$$
で与える。

前処理として最も簡単なJacobiは
$$
M^{-1} = \mathrm{diag}(K)^{-1}
$$
で、実装容易であり、収束が改善することが多い。

solver.py で自前CGを持つ利点は、外部ライブラリのAPI変更の影響を受けにくく、ログ（反復回数・残差）も統一しやすい点にある。

## 11. 固有ひずみ（$ε^{0}$）

固有ひずみは、温度ひずみ、相変態ひずみ、磁歪ひずみなどとして現れる。式は
$$
\sigma = C:(\varepsilon - \varepsilon^{0})
$$
であり、弱形式に入れると

- 左辺：$K_u$ を作る部分$（$B^{T} C B$）
- 右辺：固有ひずみ由来の等価外力 $f^{0}$

に分かれる。具体的には要素ごとに
$$
f^{0,(e)} = \int_{\Omega_e} B^{T} C\, \varepsilon^{0} \, dV
$$
が加わる。

弾性単独テストでは $ε^{0}=0$ としておき、後で磁歪結合を入れるときにここへ $ε^{0}(m)$ を接続すればよい。

## 12. 診断

弾性ソルバは、「解が出た」だけでは不十分で、最低限以下を監視するのが有用である。

(1) 収束
- CGの相対残差 $rel_res = ||r_k||/||r_0||$
- 反復回数 iters
- 収束しない場合：境界条件が剛体モードを残していないか、Cが非物理でないか、メッシュが潰れていないかを疑う

(2) エネルギーの非負
外力が純粋な変位境界条件で与えられている場合、内部ひずみエネルギーは
$$
U = \frac{1}{2}\int_{\Omega} (\varepsilon-\varepsilon^{0}) : C : (\varepsilon-\varepsilon^{0})\, dV
$$
であり、Cが正定値なら $U ≥ 0$ である。負になるなら、BやC、せん断の係数、ガウス積分、あるいは符号の実装が怪しい。

(3) 一様場（パッチテスト）での誤差
理想的な実装なら、境界にアフィン変位
$$
u(x) = A x + b
$$
を与えたとき、要素内のひずみは一定となり、数値誤差は機械誤差レベルに落ちる。これはB行列、ヤコビアン、拘束の適用が正しいかを一撃で確認する試験である。

例：せん断パッチテストとして
$$
u_x = \gamma z,\quad u_y=0,\quad u_z=0
$$
を境界全節点に課すと、期待される
$$
\gamma_{zx} = \frac{\partial u_x}{\partial z} = \gamma
$$
が空間的にほぼ一定になるはずである。

## 13. 何ができるようになったのか

ここまでの「弾性だけ」Hex8 FEMが固まると、次が可能になる。

- 格子（StructuredHex）上での3D変位場 $u$ の解
- 要素（ガウス点）でのひずみ ε、応力 $σ$ の評価
- 単純引張、単純せん断、パッチテストでの妥当性検証
- 弾性エネルギー $U$ の評価と、実装の符号・係数の基本チェック
- 固有ひずみ $ε^{0}$ の枠組みを通じて、磁歪や相変態ひずみを自然に接続する土台の確立

磁気弾性へ進むときは、$ε^{0}(m)$ を用意し、上の $f^{0}$（等価外力）計算を通じて弾性ソルバへ入力し、得られた応力・ひずみから磁気側の有効場を作る、という結合ができるようになる。

## まとめ

3D線形弾性をFEMで解くには、(i) 弱形式、(ii) Hex8形状関数とヤコビアン、(iii) $2×2×2$ ガウス積分での要素剛性、(iv) 正しいDirichlet消去、(v) SPDを前提にしたCG解法、の順に積み上げるのが最短である。パッチテスト（境界にアフィン変位を課す）で誤差が機械精度に落ちることを確認できれば、以後の磁気弾性結合や多物理場連成へ安心して進める状態になる。

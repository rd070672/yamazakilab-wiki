# 反磁界（静磁界）計算手法の検討：FFT 畳み込み法と Poisson ポテンシャル法

反磁界は磁化自身が作る長距離相互作用であり、磁区形成や形状効果を支配する主要因である。ここでは、構造格子上で反磁界 $\mathbf{H}_{d}$ を計算する2つの王道手法（FFT 畳み込み法／Poisson ポテンシャル法）を、同一初期条件で突き合わせて検証できる形に整理する。

## 参考ドキュメント
1. S. Lepadatu, Efficient computation of demagnetising fields for magnetic multilayers, 2019.
   https://arxiv.org/pdf/1906.00813
2. MuMax3 workshop tutorial (demag field / demag energy), 2020.
   https://mumax.ugent.be/mumax3-workshop/tutorial1.pdf
3. 磁位を利用したマイクロマグネティックスのための高速反磁界計算法（J-STAGE）, 反磁界計算の背景とポテンシャル法の整理.
   https://www.jstage.jst.go.jp/article/jmsjmag/17/3/17_682/_pdf/-char/ja

## 1. 反磁界とは何か：式の骨格と単位系

### 1.1 静磁場の基本式
時間変化の遅い（準静的）マイクロマグネティクスでは、磁束密度 $\mathbf{B}$ と磁場 $\mathbf{H}$、磁化 $\mathbf{M}$ の関係は

$$
\mathbf{B}=\mu_0(\mathbf{H}+\mathbf{M})
$$

である。真空透磁率は $\mu_0=4\pi\times 10^{-7}\,\mathrm{H/m}$ である。

磁化が作る静磁場は、いわゆる反磁界（demagnetizing field, stray field）であり、LLGで用いる有効磁場の一部として

$$
\mathbf{H}_\mathrm{eff} = \mathbf{H}_\mathrm{ex} + \mathbf{H}_\mathrm{ani} + \mathbf{H}_\mathrm{ext} + \mathbf{H}_{d} + \cdots
$$

に加算される。

### 1.2 反磁界の方程式（スカラー・ポテンシャル表示）
磁性体を含む全空間で、静磁場は

$$
\nabla\times \mathbf{H}_{d}= \mathbf{0},
\qquad
\nabla\cdot (\mathbf{H}_{d}+\mathbf{M}) = 0
$$

を満たす。回転がゼロなのでスカラーポテンシャル $\phi$ を導入でき、

$$
\mathbf{H}_{d} = -\nabla \phi
$$

とおける。これを代入すると（磁性体領域で）

$$
\nabla^2 \phi = \nabla\cdot \mathbf{M}
$$

という Poisson 形式が得られる。ここが Poisson 法の出発点である。

### 1.3 反磁界エネルギー
反磁界エネルギー（静磁エネルギー）は、一般に

$$
E_{d} = -\frac{\mu_0}{2}\int \mathbf{M}\cdot \mathbf{H}_{d}\, dV
$$

で与えられる。多くの場合 $\mathbf{H}_{d}$ は $\mathbf{M}$ と反平行成分を持つため、$\mathbf{M}\cdot \mathbf{H}_{d}<0$ となり、結果として $E_d>0$ になる。

### 1.4 単位の注意
- $\mathbf{H}$ は A/m である
- $\mathbf{B}$ は T である（$B=\mu_0 H$ は真空でのみ成立）
- 実装内で「外場を A/m で与える」「磁化は $\mathbf{M}=M_s \mathbf{m}$（$\mathbf{m}$ は無次元）」を徹底すると混乱が減る

目安として、$H=10^6\,\mathrm{A/m}$ は $B=\mu_0 H\approx 1.26\,\mathrm{T}$ に相当する。

## 2. 検証の論理

反磁界は長距離であり、境界条件の取り方・離散化・解法の差が結果に強く効く。そこで

- FFT 畳み込み法：矩形格子で非常に高速、定番実装（検証と運用の両方で強い）
- Poisson ポテンシャル法：境界条件を明示して解く、空気箱や将来のFEM基盤と接続しやすい（検証の拠り所として強い）

という役割分担をするのが有効である。両者は厳密に同じ境界条件を解いているとは限らないため、「完全一致」を最初から要求するのではなく、収束傾向と差の原因を説明できる状態に持ち込むことがゴールである。

## 3. FFT 畳み込み法（regular grid, convolution）

### 3.1 目的
- 構造格子（等間隔セル）で $\mathbf{H}_{d}$ を高速に出す
- 計算量を $O(N\log N)$ に抑え、大規模3Dでも現実的に回す
- 反磁界カーネルの精度（離散化誤差）を制御しつつ安定に使う

### 3.2 計算内容
反磁界は、磁化（あるいは磁極に相当する量）からの畳み込みで表現できる。代表的な見方は2つある。

(1) 反磁界テンソル（demag tensor）による畳み込み
- セルを一様磁化したと仮定し、セル間相互作用をテンソルカーネルで表す
- 実空間での畳み込みを FFT で高速化する

(2) k空間での射影（連続式の近似）
周期境界に拡張した空間で、k空間で

$$
\mathbf{H}_d(\mathbf{k})
= -\frac{\mathbf{k}\,(\mathbf{k}\cdot \mathbf{M}(\mathbf{k}))}{|\mathbf{k}|^2},
\qquad (\mathbf{k}\neq \mathbf{0})
$$

を用いて $\mathbf{H}_{d}$ を得て、逆FFTで実空間に戻す。$\mathbf{k}=0$ 成分は平均磁場に相当し、扱いを規約化する（通常 0 と置く、あるいは系の条件に合わせて定める）。

実装上は (1) の「離散テンソルカーネル（Newell型の式など）＋FFT」がより厳密・定番である一方、(2) は概念の把握が容易である。

### 3.3 開境界をどう近似するか：padding の役割
FFT は周期畳み込みであるため、そのままでは周期境界を暗に仮定する。開境界（孤立試料）を近似する典型手段がゼロパディングである。

- 試料領域の周囲に磁化ゼロの領域を付け足す
- 周期コピー同士が互いに遠ざかることで、周期相互作用の影響を弱める

このとき padding（追加セル数）を増やすと、開境界近似が改善していくことが期待される。あなたの sweep は、この「padding を増やしたときの収束」を定量化する目的を持つ。

### 3.4 長所と注意点
長所
- 非常に高速である（Poisson と比較して桁違いに速いことが多い）
- 構造格子では標準手法であり、多くの既存コードが採用している

注意点
- 周期／開境界の扱いがカーネルと padding に依存する
- 格子が非等方（nx:ny:nz が大きく違う）だと padding を各方向で調整した方が収束がきれいな場合がある
- 離散化誤差（セル一様磁化近似、階段近似）を理解しておく必要がある

## 4. Poisson ポテンシャル法（scalar potential, airbox）

### 4.1 目的
- $\nabla^2\phi=\nabla\cdot\mathbf{M}$ を数値的に解き、$\mathbf{H}_d=-\nabla\phi$ を得る
- 空気箱（airbox）を明示し、境界条件を明確にした検証系を作る
- 将来的にFEM（曲面形状、磁気弾性との統合）へ自然につなぐ

### 4.2 計算内容（離散化の流れ）
1. 磁化を無次元 $\mathbf{m}$ から $\mathbf{M}=M_s\mathbf{m}$ に戻す
2. 計算箱（磁性体＋空気）に拡張し、右辺 $\nabla\cdot\mathbf{M}$ を作る
3. Poisson 方程式を離散化して線形方程式 $A\phi=b$ を作る
4. 反復解法（CG など）で $\phi$ を解く
5. その勾配から $\mathbf{H}_d=-\nabla\phi$ を得る（中心差分など）

### 4.3 境界条件と airbox の意味
Poisson を有限領域で解く以上、外周境界条件を選ぶ必要がある。簡単な選択肢が Dirichlet 境界（外周で $\phi=0$）である。

- airbox が小さいと、外周条件が試料の場に直接影響し、反磁界が系統的に歪む
- airbox を大きくすると、試料から外周までの距離が増え、境界条件の影響が弱まる

したがって air_cells を増やして結果が頭打ちになるかを見れば、「境界の影響が十分小さい」ことを確認できる。この sweep はその確認でもある。

### 4.4 長所と注意点
長所
- 境界条件を明示するため、差の原因が追いやすい
- 空気箱や材料の領域分割を入れやすい
- FEM化・異方的メッシュ・他物理（弾性）との統合に親和的である

注意点
- FFTに比べて重い（3Dで未知数が増えるため）
- 収束性が前処理に依存する（pyamg 等の前処理が効く）
- Dirichlet/Neumann の選び方で系統誤差が出るので、airboxで抑える設計が必要である

## 5. 2手法の比較指標：何が一致すべきか

あなたの demag_compare では、同一の $\mathbf{m}(x)$ を固定し、FFT と Poisson で $\mathbf{H}_d$ と $E_d$ を計算し、以下で比較している。

### 5.1 ベクトル場の差：相対L2誤差
$$
\mathrm{relL2}(\mathbf{H})
=\frac{\|\mathbf{H}_{fft}-\mathbf{H}_{poi}\|_2}{\|\mathbf{H}_{fft}\|_2}
$$
- 0 に近いほど一致である
- 局所的な強度差にも敏感である

### 5.2 パターン一致：相関係数
ベクトル成分を並べた相関係数 $\mathrm{corr}(\mathbf{H})$ を取ると、スケール差があっても空間パターンが一致しているかを見やすい。

### 5.3 方向一致：$\cos\theta$ の平均
各セルで

$$
\cos\theta
=\frac{\mathbf{H}_{fft}\cdot \mathbf{H}_{poi}}{|\mathbf{H}_{fft}||\mathbf{H}_{poi}|}
$$

を計算し、その平均を見る。これは「方向のバグ」を強く検出する指標である。$\cos\theta\simeq 1$ なら方向は揃っている。

### 5.4 エネルギー一致：$E_d$ の相対差
$$
E_\mathrm{rel}=\frac{|E_{fft}-E_{poi}|}{|E_{poi}|}
$$
LLG緩和や磁区形成ではエネルギーが重要であるため、$E_d$ の一致は特に意味が大きい。

### 5.5 sweep の読み方
- air_cells を増やすと Poisson が外周の影響から解放され、エネルギー差が縮む傾向が出る
- fft_padding を増やすと FFT の開境界近似が改善し、同様に差が縮む傾向が出る
- 方向一致（$\cos\theta$）が先に 1 に近づき、強度差（relL2）が後から詰まることがある
  - 境界条件が違うと、同じパターンでも強度が系統的にずれるためである
  - その場合、airbox/padding を増やしたときに差が頭打ちになる点が「この2手法の差の下限」である

## 6. 実装設計としての位置づけ：なぜこの順番が良いか

### 6.1 有効磁場の合成への組み込み
反磁界は他の局所項（交換・異方性・外場）と同じく、最終的には $\mathbf{H}_\mathrm{eff}$ に足し込まれる。したがって実装は

- demag.py が $\mathbf{H}_d$ を返す（method 切替あり）
- effective_field.py が他項と同列に合成する
- diagnostics.py が $E_d$ を含むエネルギー分解を出す

という分離が自然である。

### 6.2 収束と検証の階段
1. まず FFT で demag を入れて磁区が出ることを確認する（高速で試行回数を稼げる）
2. Poisson を使って、境界条件付きの解として妥当かを突き合わせる（検証軸）
3. sweep により、airbox/padding の選び方が「収束して頭打ちになる」ことを示す
4. その上で LLGの時間発展（減衰下で $dE/dt\le 0$）が安定に回ることを確認する

この順に積むと、バグの切り分けが直線的になる。

## 7. 注意点と対策

- Poisson 境界の影響が強い
  - airbox を増やす
  - 境界条件（Dirichlet固定）自体の系統誤差を意識し、比較は「収束後」に行う

- FFT の open 近似が不十分
  - padding を増やす（必要なら各方向で別に）
  - 格子が細長い場合、薄い方向の padding を厚めに取ると改善することがある

- $\mathbf{k}=0$ の扱いで平均場がブレる
  - 規約（0にする等）を固定し、ログで明示する

- 単位の取り違え
  - $\mathbf{M}=M_s\mathbf{m}$ を徹底する
  - ログに $|\mathbf{H}_d|$ と $\mu_0|\mathbf{H}_d|$ の両方（A/m と T）を併記する

## 8. まとめ

反磁界は長距離相互作用であり、境界条件と離散化の差が結果に敏感である。FFT 畳み込み法は構造格子で高速に反磁界を計算でき、Poisson ポテンシャル法は境界条件を明示した検証系として有効である。両者を同一初期磁化で突き合わせ、padding と airbox を掃引して誤差が頭打ちになる点を押さえることで、実装の健全性と差の原因を説明可能な形で確立できるのである。

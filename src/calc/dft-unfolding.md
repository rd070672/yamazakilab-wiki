# バンドアンフォールディング法

スーパーセル計算で得られる「折り畳まれた」バンド構造を、参照単位胞（primitive / conventional）のブリルアンゾーンへ写像し直す手法がバンドアンフォールディング（band unfolding）である。欠陥・合金・界面・歪みの電子状態を、理想結晶や分光測定（ARPESなど）と比較しやすい表現へ変換できる。

## 参考ドキュメント
- Ref-P1: Popescu & Zunger, Phys. Rev. B 85, 085201 (2012) “Extracting E versus k effective band structure from supercell calculations on alloys and impurities”
- Ref-J1: OpenMX マニュアル（日本語）「バンドアンフォールディング法」
- Ref-O1: VASPKIT Documentation “Band-unfolding” セクション

## 1. folding問題の正体

スーパーセル（SC）は、欠陥導入・固溶・表面スラブ・再構成など「周期を大きく取らないと表現できない構造」を扱うための標準的なモデルである。一方で、実空間周期を大きくすると逆空間のブリルアンゾーン（BZ）は小さくなり、同じエネルギー窓に多数のバンドが密集して現れる。

- primitive cell（PC）でのBZ：大きい
- supercell（SC）でのBZ：PCより小さい（縮む）
- PCの単純なバンド分散は、SCでは小さなBZに折り畳まれて見える（folding）

このため、SCの生バンド図は「情報が増える」というより「表示が難しくなる」ことが多い。アンフォールディングは、この折り畳みをPC側のBZに戻して（unfoldして）見通しを回復する操作である。

ARPESのような実験では、観測される周期性が「測定で見えている実効的な周期」になる。SC計算の周期（人工的な周期）と実験での周期が一致しない場合、そのままのバンド図比較は混乱を生みやすい。アンフォールディングは、比較対象の周期（参照単位胞）に合わせて電子状態を表現し直すための装置である（Ref-J1）。

## 2. バンドの「Bloch性（重み）」

アンフォールディングは、単にエネルギー固有値を並べ替える操作ではない。ポイントは「SCの固有状態が、PCのどの波数kにどの程度対応するか」を重み（spectral weight）として評価し、その重み付きでPC-BZ上に散布する点にある。

SCの固有状態を $|Ψ_{nK}⟩$（バンド$n$、SC波数K）とすると、PCのBloch波（あるいはPC周期に整合する平面波成分）への射影によって、PC波数kでのBloch重み $w_{n(k)}$ を定義する。

有効バンド構造（effective band structure; EBS）は、概念的には次のようなスペクトル関数で表せる：

$$
A(\mathbf{k},E)=\sum_{n} w_{n}(\mathbf{k})\,\delta\!\left(E-\varepsilon_{n\mathbf{K}(\mathbf{k})}\right)
$$

ここで $δ$ は可視化のためガウス幅 $η$ で平滑化されることが多い：

$$
\delta(E-\varepsilon)\;\rightarrow\;\frac{1}{\sqrt{2\pi}\eta}\exp\!\left[-\frac{(E-\varepsilon)^2}{2\eta^2}\right]
$$

EBSは「PCのバンド図と同じ見た目」に近づくが、重要なのは各点に強度（重み）が付随し、欠陥・乱れ・混成により重みが薄れたり広がったりする点である。

## 3. 変換行列Mとk点の対応関係

PCの実空間基底ベクトルを $(a_1,a_2,a_3)$、SCの基底ベクトルを $(A_1,A_2,A_3)$ とすると、整数行列Mを用いて

$$
\begin{pmatrix}
\mathbf{A}_1\\ \mathbf{A}_2\\ \mathbf{A}_3
\end{pmatrix}
=
\mathbf{M}
\begin{pmatrix}
\mathbf{a}_1\\ \mathbf{a}_2\\ \mathbf{a}_3
\end{pmatrix}
$$

が成り立つ。逆格子側は概略として

$$
\mathbf{B} = (\mathbf{M}^{-1})^{T}\mathbf{b}
$$

（$B$ がSC逆格子ベクトル、$b$ がPC逆格子ベクトル）で関係づく。

SC-BZが縮むということは、PCのある波数kが、SCではKへ「折り畳まれる」ことを意味する。一般に同一のKに対応するPC波数は複数存在し、そこにSC固有状態 $|Ψ_{nK}⟩$ のBloch性が分配される。アンフォールディングは、その分配を $w_{n(k)}$ として可視化する。

## 4. 平面波基底の典型

平面波基底（多くの擬ポテンシャル平面波DFT）では、SC波動関数は

$$
\Psi_{n\mathbf{K}}(\mathbf{r})=\sum_{\mathbf{G}} C_{n\mathbf{K}}(\mathbf{G})\,e^{i(\mathbf{K}+\mathbf{G})\cdot\mathbf{r}}
$$

と展開できる（GはSC逆格子ベクトル）。PCの波数kに対応する重みは、PC周期に整合する成分を集めた形で評価できる。直感的には

- あるPC波数kに対し、$(k+g)$ の形（gはPC逆格子）で表される平面波成分が、SC波動関数の中にどれだけ含まれているか
- それら係数の二乗和が $w_{n(k)}$ に対応する

というイメージである。Popescu–ZungerのEBSは、この考え方を一般のスーパーセルへ体系化した代表的枠組みである。

局在基底（原子軌道基底）の場合は、係数に加えて基底の重なり（overlap）や原子・軌道選択（局所投影）を取り込んだ形で類似の重みを定義する。界面・層ごとの$k$射影、局所バンド構造などの拡張は、この「どこに局在する成分を数えるか」を工夫した派生である。

## 5. 何が見えるようになるか

### 5.1 欠陥準位と局在
点欠陥はPC対称性を破り、Bloch性を弱める。結果として
- バンド内部に現れる欠陥準位は、特定kに鋭い線として出るとは限らず、重みが広がったり薄れたりする
- 局在が強いほどk選択性が弱くなる傾向がある（k空間でぼやける）

### 5.2 合金・組成揺らぎとバンドのブロード化
ランダム合金・固溶では、平均構造（仮想結晶）に対して散乱が入り、PCの単純なバンド線が太る（ブロードニング）・一部の重みが他kへ漏れる、という形で現れることが多い。BandUPやQuantumATKのEBSチュートリアルはこの文脈（合金のEBS）を明示している。

### 5.3 界面・再構成・歪みとゴーストバンド
表面再構成や界面で新周期が生まれる場合、参照単位胞の取り方により
- 元のPCバンドが弱く残る（ゴースト）
- 新周期由来の折り返し成分が現れる
などの混合パターンになる。ここでは「比較したい周期（参照セル）は何か」を先に決めることが重要である。

## 6. 標準ワークフロー

1) 参照セル（PCまたは比較に適した単位胞）を決め、PC-BZの高対称kパスを定義する  
2) 参照セルを拡張してSCを構築する（欠陥・合金・スラブなど）  
3) SC構造を緩和し、同一SCでバンド計算用の波動関数情報も出力する  
4) 参照セルのkパスに対し、SC側で必要なk点集合（折り畳み対応）を準備する  
5) 波動関数から重み w_n(k) を計算し、PC-BZ上に重み付きで描画する  
6) 必要に応じて原子・軌道・層投影を併用し、どの成分がどこに起因するかを確認する

実際のツールは上記を自動化するが、失敗の多くは「参照セルの選択」「変換行列の指定」「k点対応の不整合」に起因する。

## 7. 主要ツールの比較

| 系統 | 代表例 | 入力の核 | 特徴 |
|---|---|---|---|
| EBSの古典的枠組み | Popescu–Zunger | SC固有状態のPCへの射影 | 合金・不純物・欠陥のEBSを体系化 |
| 平面波DFT向けポスト処理 | VASPKIT / VaspBandUnfolding / fold2Bloch-VASP | 波動関数係数（WAVECAR等） | SC波動関数を読み、重みを算出して可視化 |
| 投影情報を用いたunfold | PyProcar | PROCAR（位相因子を含む設定が必要） | 既存の投影解析と連携しやすい |
| 他コード組込み/周辺 | OpenMX（組込み） | 入力でunfold指定 | コリニア/ノンコリニア両対応を明記 |
| 商用・統合環境 | QuantumATK | EBSオブジェクト | 合金例を含むチュートリアルが整備 |

## 8. 注意点

- アンフォールディング強度はARPES強度そのものではない  
  実験では遷移行列要素、光の偏光、最終状態効果、寿命による幅などが効く。EBSは「周期性とBloch性の地図」であり、比較の前提として差を意識すべきである。

- 参照セルの選び方が結果の解釈を支配する  
  PCかconventional cellか、基板周期か被覆層周期か、どのBZを「正」と見なすかで、見えるものが変わる。

- SOC・ノンコリニアではスピノル波動関数に対応した実装を使う  
  波動関数の自由度が増えるため、対応していない実装では重みの扱いが破綻しうる。OpenMXはノンコリニアでも対応すると明記している。

- 重みの規格化（合計が概ね1になるか）のチェックが有効である  
  参照セル・変換行列・k点対応が正しい場合、同一状態の重みは対応するk集合に分配される。合計が極端にずれる場合は設定ミスの可能性が高い。

## 9. まとめ

バンドアンフォールディング法は、スーパーセル由来の折り畳みを参照単位胞のブリルアンゾーンへ「重み付きで」戻し、欠陥・合金・界面・歪みの電子構造を見通しよく比較可能にする手法である。参照セル選択、変換行列、k点対応、波動関数出力の整合が結果の品質を決めるため、手順の各段で整合性チェックを挟むことが有効である。


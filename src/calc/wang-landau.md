# Wang–Landauシミュレーション入門

Wang–Landau（WL）法は、状態密度（density of states; DOS）を直接推定し、熱平衡計算では現れにくい高い自由エネルギー障壁をまたいで系を探索する拡張アンサンブル法である。推定したDOSから分配関数を再構成することで、広い温度域の熱力学量や一次相転移の特徴量を一括して評価できる枠組みである。

## 参考ドキュメント
1. F. Wang and D. P. Landau, Efficient, Multiple-Range Random Walk Algorithm to Calculate the Density of States, Phys. Rev. Lett. 86, 2050 (2001). https://link.aps.org/doi/10.1103/PhysRevLett.86.2050
2. F. Wang and D. P. Landau, Determining the density of states for classical statistical models: A random walk algorithm to produce a flat histogram, Phys. Rev. E 64, 056101 (2001). https://link.aps.org/doi/10.1103/PhysRevE.64.056101
3. 日本物理学会講演概要集（J-STAGE）内のWang–Landau法関連（例：ワン・ランダウ法を用いた解析事例） https://www.jstage.jst.go.jp/article/jpsgaiyo/73.2/0_73.2_1384/_article/-char/ja

## 1. 背景：なぜ状態密度を狙うのか

通常のMetropolis法は、温度Tにおけるボルツマン重み
$P(x)\propto \exp(-\beta E(x))$（$\beta=1/k_{B}T$）
に従って状態$x$をサンプリングする。これは平衡物性（比熱、磁化など）には有効である一方、次の状況で探索が停滞しやすい。

- 一次相転移や核生成：界面の形成などに起因する自由エネルギー障壁が大きい
- ガラス的・フラストレーション系：粗いエネルギー地形（rugged landscape）で局所極小に捕まりやすい
- 欠陥・不純物・ドメイン構造：稀事象（rare events）が物性を支配する

この停滞を本質的に避ける発想が、「まずDOS $g(E)$ を推定し、重みを手で設計してエネルギー空間を均一に歩かせる」ことである。

## 2. 状態密度と再重み付け：統計力学の骨格

系のエネルギーが離散化できる（あるいはbinで離散化する）とき、DOSを
$$
g(E)=\#\{x \mid E(x)=E\}
$$
と定義する。DOSが分かれば、任意温度の分配関数は
$$
Z(\beta)=\sum_{E} g(E)\,e^{-\beta E}
$$
で与えられる。期待値は
$$
\langle A\rangle_{\beta}=\frac{1}{Z(\beta)}\sum_{E} \langle A\rangle_{E}\, g(E)\, e^{-\beta E}
$$
と書ける（$\langle A\rangle_{E}$はエネルギーEに属するミクロ状態での平均である）。

さらに、エントロピーと自由エネルギーは
$$
S(E)=k_{B}\ln g(E), \quad F(\beta)=-k_{B}T\ln Z(\beta)
$$
である。したがってWL法は、単にサンプリングを安定化する道具ではなく、熱統計の生成関数（$Z$）を数値的に組み立てる方法である。

## 3. Wang–Landau法の基本アイデア（フラット・ヒストグラム）

狙いは、エネルギーEの出現頻度（ヒストグラム）$H(E)$を可能な限り平坦にすることである。
もし重み関数を
$$
W(E)\propto \frac{1}{g(E)}
$$
と取れれば、サンプリング分布は
$P(E)\propto g(E)W(E)\approx \text{const}$
となり、エネルギー空間でのランダムウォークが平坦になる。

しかし$g(E)$は未知であるため、WL法ではサンプリングと同時に$g(E)$の推定値$\tilde{g}(E)$を逐次更新する。更新は通常、数値安定性のため$\ln \tilde{g}(E)$（あるいは$S(E)$）で扱う。

## 4. アルゴリズム

### 4.1 変数の準備
- エネルギー範囲$[E_{\min},E_{\max}]$をbin幅$\Delta E$で離散化し、bin indexを$i$とする
- 推定量：$\ln \tilde{g}(E_{i}) \leftarrow 0$
- ヒストグラム：$H(E_{i}) \leftarrow 0$
- 修正因子：$f>1$（典型例として$\ln f=1$から開始、段階的に1へ近づける）

### 4.2 遷移確率（WL版Metropolis）
現在の状態を$x$、提案状態を$x'$とし、$E=E(x)$、$E'=E(x')$とする。
WL法での受理確率は
$$
p_{\text{acc}}=\min\left(1,\frac{\tilde{g}(E)}{\tilde{g}(E')}\right)
=\min\left(1,\exp(\ln\tilde{g}(E)-\ln\tilde{g}(E'))\right)
$$
である。ここでの直感は「既に大きく推定されているDOSの領域には入りにくくし、訪問回数を均す」ことである。

### 4.3 訪問後の更新（学習ステップ）
1ステップごとに、最終的に到達したエネルギーbin $E_{i}$について
$$
\ln \tilde{g}(E_{i}) \leftarrow \ln \tilde{g}(E_{i}) + \ln f
$$
$$
H(E_{i}) \leftarrow H(E_{i}) + 1
$$
と更新する。これは「訪れたbinのDOS推定を増やし、次はそこへ戻りにくくする」操作である。

### 4.4 段階更新
一定ステップごとに$H(E)$の平坦性を判定し、平坦であれば
- $H(E)\leftarrow 0$（リセット）
- $f \leftarrow \sqrt{f}$（あるいは $\ln f \leftarrow \frac{1}{2}\ln f$）
とする。$f\to 1$に近づくほど更新が弱まり、$\tilde{g}(E)$が収束する。
終了条件は例として $\ln f < \varepsilon$（$\varepsilon$は数値設定）などで与える。

## 5. 実装上の要点

### 5.1 連続系とbinning
原子系（オフラティス）や連続スピン系ではエネルギーが連続であるため、bin幅$\Delta E$の選び方が誤差と計算コストを決める。
- $\Delta E$が粗すぎると微細な構造（比熱ピーク、擬ギャップなど）を潰す
- 細かすぎるとbin数が増え、ヒストグラムが平坦化しにくい

連続系向けの改良WL（bin内補間やjoint DOSの扱いなど）が提案されている。

### 5.2 エネルギー窓分割（multiple-range）
広いエネルギー範囲は、重なりを持つ複数の窓に分けてWLを走らせ、窓の重複領域で$\tilde{g}(E)$の相対スケールを合わせて接続する方法が有効である。
一次相転移近傍など局所的に障壁が高い領域だけを高精度に学習する戦略も取れる。

### 5.3 観測量の拡張：joint DOS
材料物性では、エネルギーだけでなく秩序変数（磁化M、原子種濃度c、歪み指標、局所秩序など）を同時に見たいことが多い。
joint DOS
$$
g(E,Q)
$$
を推定できれば、温度だけでなく外場（磁場H、化学ポテンシャル差、応力など）に対する応答を再重み付けで走査できる。

### 5.4 収束と検証
WLは学習中に詳細釣り合いを厳密には満たさないが、$f\to 1$で更新が弱まるにつれて定常分布が整う、という設計思想である。
検証としては次が実用的である。
- 既知解（小サイズの厳密計算）との比較
- 窓分割した場合の接続一貫性（重複領域での$\ln \tilde{g}(E)$のズレ）
- 期待値の再構成が温度に対して滑らかか（不自然なギザつきがないか）

## 6. 何が計算できるか

DOSが得られると、以下が一つの計算フローで得られる。

- 内部エネルギー：$\langle E\rangle(T)$
- 比熱：$C(T)=\frac{d\langle E\rangle}{dT}$（あるいはエネルギー揺らぎ式）
- 磁化や秩序変数：$\langle M\rangle(T,H)$（joint DOSがあると特に強い）
- 自由エネルギー：$F(T)$、相安定性の比較
- 一次相転移の特徴：潜熱、二峰性のエネルギー分布、界面形成に由来する障壁の推定
- 準安定相・核生成：自由エネルギーのランドスケープ上での遷移経路の理解（$F(Q)$など）

特に一次相転移では、カノニカル分布が二相の間の領域を極端に抑圧するため、WLの「平坦化」が直接的に効く。

## 7. 材料・固体モデルでの典型的な適用先

- 磁性モデル：Ising/Heisenberg/XY、フラストレート格子、スピン格子の相転移
- 合金・規則不規則転移：格子ガス、クラスター展開Hamiltonian、半大正準（semi-grand-canonical）への展開
- 表面吸着・拡散：吸着等温線や相分離、欠陥の形成自由エネルギー
- 高分子・ソフトマター：折り畳み、エントロピー駆動の相転移（材料設計上の類似問題として現れる）
- 量子系の拡張：拡張アンサンブル量子モンテカルロの文脈でのWang–Landau（量子WL）も議論されている

## 8. 他手法との位置づけ

| 手法 | 目的 | 強み | 注意点 |
|---|---|---|---|
| Metropolis（カノニカル） | ある温度での平衡平均 | 実装が簡単、局所更新でも扱える | 障壁が高いと停滞 |
| レプリカ交換（REMC） | 温度間交換で障壁回避 | 連続系でも使いやすい | 温度点の設計と通信コスト |
| マルチカノニカル | 重み$1/g(E)$で平坦化 | 理論的に明快 | 重み推定が難しい |
| Wang–Landau | DOSを逐次推定して平坦化 | DOSから広い温度域を再構成 | binningと収束検証が重要 |

WLは「重み（DOS）を自動で学習するマルチカノニカル」と捉えると理解しやすい。

## まとめ

Wang–Landau法は状態密度を直接推定し、エネルギー空間の平坦化によって自由エネルギー障壁を跨ぐ探索を可能にする手法である。得られたDOSから分配関数を再構成できるため、単一計算で広い温度域の熱物性や相転移指標、自由エネルギー地形を一貫して評価できる点が強みである。一方で、連続系のbinning、エネルギー窓の接続、収束判定と検証が精度を支配するため、モデル特性に応じた設計と妥当性確認が要点である。


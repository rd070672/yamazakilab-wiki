# レプリカ交換モンテカルロ（Replica Exchange Monte Carlo, REMC / Parallel Tempering）

レプリカ交換モンテカルロ（REMC, Parallel Tempering）は、温度（またはハミルトニアン）が異なる複数のレプリカを並列に走らせ、一定間隔でレプリカ間の交換を行うことで、複雑なエネルギー地形におけるサンプリング停滞を緩和する拡張アンサンブル法である。材料科学では、相転移近傍、欠陥・合金無秩序、表面吸着、非晶質・準安定構造探索など、局所更新だけでは混合が遅い問題で有効である。

## 参考ドキュメント（3つ）
- D. J. Earl, M. W. Deem, Parallel tempering: Theory, applications, and new perspectives, Phys. Chem. Chem. Phys. 7, 3910 (2005)
  https://pubs.rsc.org/en/content/articlelanding/2005/cp/b509983h
- K. Hukushima, K. Nemoto, Exchange Monte Carlo Method and Application to Spin Glass Simulations, J. Phys. Soc. Jpn. 65, 1604 (1996)
  https://www.jstage.jst.go.jp/article/jpsj/65/6/65_6_1604/_article
- 2DMATドキュメント（日本語）：交換モンテカルロ法（レプリカ交換/パラレルテンパリングの説明）
  https://issp-center-dev.github.io/2DMAT/manual/master/ja/algorithm/exchange.html


## 1. 何が問題で、REMCは何を解決するか
### 1.1 通常のMCが詰まりやすい状況
単一温度のMetropolis MCは、局所更新（スピン反転、原子種スワップ、格子点占有のフリップなど）で状態を更新するため、次の状況で停滞しやすい。

- 多数の準安定状態がある（多谷・ruggedな自由エネルギー地形）
- 相転移近傍で緩和が遅い（臨界スローダウン）
- 実効的に多峰性の分布を持つ（相共存、秩序化、相分離など）

材料科学の例としては、クラスター展開（cluster expansion）を用いた合金の秩序化・相分離、原子論的スピン模型の低温磁気配置、吸着系の被覆率・配列、欠陥配置の探索などが該当しやすい。

### 1.2 REMCのコアアイデア
高温は障壁越えが容易で探索が広く、低温は谷の深部を精密にサンプルできる。REMCは
- 高温側で得た配置を交換で低温側へ運ぶ
- 低温側のレプリカが高温へ“逃げる”ことで谷から脱出する
という往復（温度方向のランダムウォーク）を実現し、平衡化と混合を加速する枠組みである。


## 2. 基本設定と目標分布
温度が異なるM個のレプリカを用意し、温度列を

$$
T_1 < T_2 < \cdots < T_M,\quad \beta_k=\frac{1}{k_{\mathrm{B}}T_k}
$$

とする。各レプリカ$k$は、同じハミルトニアン$H(x)$（$x$は状態：スピン配列、原子占有、原子座標など）に対して、正準分布

$$
\pi_k(x)\propto \exp\left(-\beta_k H(x)\right)
$$

をサンプルすることが目的である。


## 3. アルゴリズム
REMCは「各温度での局所MC更新」と「温度間の交換提案」の2種類の遷移を交互に行う。

1) 各レプリカkを、それぞれの温度T_kで、通常のMC（Metropolisなど）によりn_step回更新する  
2) 交換ステップ：隣接温度 $(k,k+1)などのペアを選び、状態の交換 $x_k ↔ x_{k+1}$ を提案する  
3) 上記を繰り返す


## 4. 交換の受理確率（詳細釣り合い）
隣接温度kとk+1のレプリカ間で、交換前が $(x_k, x_{k+1})$、交換後が $(x_{k+1}, x_k)$ のとき、Metropolis受理確率は

$$
p_{\mathrm{acc}}
=
\min\left(
1,\,
\exp\left[(\beta_k-\beta_{k+1})\left(H(x_{k+1})-H(x_k)\right)\right]
\right)
$$

である。ここで、交換が高頻度に受理されるには、隣接温度におけるエネルギー分布が十分に重なっている必要がある。


## 5. 温度ラダー設計（実務で効く部分）
REMCの性能は温度点の置き方で大きく決まる。基本方針は次である。

- 隣接温度でエネルギー分布が重なるように$T_k$を配置する
- 交換受理率が極端に低い区間を作らない
- レプリカが温度方向に往復（round trip）できるようにする

### 5.1 典型的な温度配置
- 等比（幾何）配置：$T_k=T_1 r^{k-1}$
- 転移近傍で密、離れた領域で粗：比熱やエネルギー分散が大きい領域に温度点を追加する
- 予備計算で受理率を測り、$T_k$を自動調整する（適応的温度ラダー）

### 5.2 交換頻度の目安
- 交換が少なすぎると温度方向の拡散が遅い
- 交換が多すぎると各温度での局所緩和が不足しうる
最適比は系や局所更新の種類に依存するため、ラウンドトリップ時間や自己相関を診断して決めるのが現実的である。


## 6. 正しく回っているかの診断
材料系への適用では、見かけの物性計算より先に、混合・平衡化を確認すべきである。

- 交換受理率の温度依存：ある温度帯だけ極端に低くないか
- レプリカの温度インデックスの時系列：温度方向に拡散しているか
- ラウンドトリップ回数：低温↔高温を何回往復したか
- 観測量の収束：ビニングや複数初期条件で平均値・分散が一致するか

相転移が絡む場合は、有限サイズ効果やヒステリシスにより収束が遅く見えるため、サイズ依存と合わせて確認するのが定石である。


## 7. 一般化：温度以外を交換する（ハミルトニアンREMC）
REMCは温度だけでなく、レプリカごとに異なるハミルトニアン$H_k(x)$を割り当て、隣接レプリカの交換を行う形へ一般化できる。

- バイアス（傘ポテンシャル）を変える：自由エネルギー計算や希事象（核生成、界面移動など）
- 相互作用強度や拘束の強さを変える：強い拘束下で構造を整え、弱い拘束へ受け渡す
- 反応座標や結合制約を変える：ポテンシャル地形の“道”を作る

温度REMCは正準分布の改善に直結するのに対し、ハミルトニアンREMCは探索性（barrier crossing）や自由エネルギー推定のための設計として使われることが多い。


## 8. 適用メニュー
表：材料科学での典型用途とREMCが効く理由

| 対象 | 状態xの例 | 停滞の原因 | REMCの効果 |
|---|---|---|---|
| 合金の秩序化・相分離（格子模型/クラスター展開） | 原子種の占有配列 | 相共存・秩序化で多峰性 | 温度往復で相空間の混合を改善 |
| 原子論的スピン模型 | スピン配列（古典ベクトル/Isingなど） | 多数の準安定磁気配置 | 低温の停滞を緩和し平衡化しやすい |
| 表面吸着・配置探索 | 格子占有、吸着サイト状態 | 被覆率・相転移・配列競合 | 高温探索を低温へ移送 |
| 非晶質・準安定構造（粗視化模型） | 局所構造の離散自由度 | 多谷地形 | 脱出・探索の支援 |
| 物性推定のためのMC平均 | 任意（上記） | 自己相関が長い | 有効サンプル数を増やす |

注意として、原子座標を連続変数として扱う分子シミュレーション系では、MD版のREMD（Replica Exchange Molecular Dynamics）がよく使われるが、MC版REMCと基本原理は同じである。


## 9. 近縁法との関係
- Simulated annealing：最適化寄りであり、サンプリング（平衡分布）とは目的が異なる
- Simulated tempering：温度を一つの鎖で上下させるが、温度重み推定が必要になりやすい
- マルチカノニカル/Wang–Landau：エネルギー重みを推定して平坦化する。重み推定が負担だが、条件によって強い
- REMC：実装が比較的簡単で並列化もしやすく、汎用性が高い

材料研究の実務では、まずREMCで混合を改善し、必要に応じて自由エネルギー計算や希事象に拡張手法を併用する、という流れが成立しやすい。


## まとめ
レプリカ交換モンテカルロ（REMC / Parallel Tempering）は、複数温度（または複数ハミルトニアン）の並列サンプリングと交換操作により、多谷地形・相転移近傍・多峰性分布での混合を改善する拡張アンサンブル法である。材料科学では、合金無秩序・磁性模型・吸着配列・準安定構造探索など、局所更新だけでは平衡化が難しい問題に対し、並列計算資源を活かして堅牢にサンプリング品質を上げる選択肢となる。

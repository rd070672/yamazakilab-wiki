# VASPによる第一原理計算

VASPによる金属・磁性体の第一原理計算は、スミアリングとk点、初期磁気配置、対称性設定が結果を支配することが多い。ここでは、再現性のある入力の作り方と、典型ワークフロー（構造最適化→静的計算→DOS/磁性→SOC）を実務手順として整理する。

## 参考ドキュメント
- VASP Wiki（タグ仕様・注意点の一次情報）
  https://www.vasp.at/wiki/
- VASP Tutorials（磁性を含む例題）
  https://www.vasp.at/tutorials/latest/
- （日本語）名工大 量子ビーム・材料計算メモ：VASP
  https://ryokbys.web.nitech.ac.jp/pages/vasp

## 0. 何を計算しているか
- 金属では部分占有が本質であり、占有数の扱い（ISMEAR/SIGMA）とk点密度がエネルギー・力・磁気モーメントに直結する。
- 磁性体では、初期磁気モーメント（MAGMOM）と対称性（ISYM）が、収束先（FM/AFM/消磁）を分岐させる。
- SOC（スピン軌道相互作用）を入れるとエネルギー差が非常に小さくなることがあり（例：磁気異方性）、k点・電子収束の要求が一段厳しくなる。

## 1. 入力ファイルと実行バイナリ
入力は次の4つが基本である。
- POSCAR：格子と原子配置
- POTCAR：PAWデータ（元素と価電子の定義）
- KPOINTS：k点メッシュまたは自動生成
- INCAR：計算条件（電子・イオン・磁性・出力）

実行は目的で使い分ける。
- vasp_std：通常の（コリニア）計算
- vasp_ncl：非コリニア磁性・SOCを含む計算

## 2. 推奨ワークフロー
金属・磁性体では、次の2段階設計が事故を減らす。
1) 収束設計（ENCUT/k点/スミアリング/磁性初期化）を決める
2) 目的物性に応じて計算を派生させる（構造、DOS、MAEなど）

以降、よく使う順に手順を並べる。

## 3. 事前チェック
### 3.1 ENCUTと精度タグ
- ENCUTは必ず手動で指定し、比較計算間で揃える（元素が変わるとデフォルトが変動しうるためである）。
- PRECは通常 Accurate を基準にし、差分（磁気異方性や相対安定性）を見る場合ほど設定を固定する。

### 3.2 LREAL（実空間射影の近似）
- LREAL=Autoは高速化に効く一方、系・設定により（小さくない）誤差やエネルギーシフトを含むことがある。
- 表面/欠陥/組成差などのエネルギー差は、同一のENCUT/PREC/LREAL等で揃えて評価するのが基本である。

## 4. 金属計算の肝：スミアリング（ISMEAR/SIGMA）とE0
### 4.1 代表設定
金属の構造最適化（力を安定にしたい）：
- ISMEAR=1 または 2 を用い、SIGMAを適切に取る。
- 目安として、OUTCARのエントロピー寄与が原子あたり十分小さい条件に調整する。

金属の静的計算（エネルギー比較・DOSなど）：
- スミアリング条件を固定し、可能ならk点を増やしてE0（0 K外挿）側で比較する。
- 目的がDOSなら、スミアリング幅を過大にしない（ピークが潰れるためである）。

補足：
- エネルギー出力には自由エネルギー（F）と0 K外挿（E0）が並ぶ。金属ではFとE0のどちらを比較するかを最初に決め、論文・ノート内で統一するのが事故防止になる。

### 4.2 KPOINTSの考え方
- 金属はフェルミ面近傍が効くため、k点収束が遅い。最小でも「エネルギー差（meV/atom）」「磁気モーメント（μB）」「応力」の収束を確認する。
- 単位格子が小さいほど高密度k点が必要になりやすい。
- 自動生成（Gamma中心など）を使う場合でも、最終的には収束テストで数値を決める。

KPOINTS例（Gamma中心の自動メッシュ）：
```
0
Gamma
12 12 12
0  0  0
```

## 5. コリニア磁性（FM/AFM）の標準手順
### 5.1 まずはスピン分極を入れる
- ベースは ISPIN=2 である。
- 初期磁気モーメント MAGMOM でFM/AFM/フェリの初期化を与える。

重要：
- 収束後にWAVECAR/CHGCARから再開する場合、MAGMOMを消すと対称化により磁化が落ちることがある。再開時もMAGMOMの設計を意識する。

### 5.2 AFM初期化の作法（例）
- AFMは原子ごとに符号を変えてMAGMOMを割り当てる。
- 同一元素でも結晶学的に非等価なサイトがある場合、サイト順（POSCARの並び）に沿って割り当てる。
- 対称性が強いとAFMが潰れる場合があるため、必要に応じて対称性設定（ISYM）を疑う。

## 6. SOC・非コリニア（磁気異方性やスピン方向を扱う）
### 6.1 SOCを入れる最小条件
- LSORBIT = .TRUE. はSOCを有効化し、非コリニア計算として扱われる。
- 実行は vasp_ncl を用いる。
- SOC計算では、対称性（ISYM）を切った場合に結果が変わるかを必ずテストするのが推奨である。

スピン量子化軸や向きは SAXIS や、非コリニアのMAGMOM（3成分）で与える。

### 6.2 磁気異方性エネルギー（MAE）の典型手順
1) 高精度なコリニア計算で基底状態の電荷密度を得る（vasp_std）
2) その電荷密度を固定して（ICHARG=11）、スピン方向を変えたSOC計算を複数回行う（vasp_ncl）
3) 全エネルギー差からMAEを決める

MAEではμeV/atom級の差分を扱うことがあるため、k点・ENCUT・収束条件を強化し、設定を全方向で厳密に一致させるのが要点である。

## 7. INCARテンプレート
### 7.1 金属：構造最適化（非磁性または磁性弱い金属）
```
SYSTEM = metal_relax
ENCUT  = (手動で固定)
PREC   = Accurate
ISMEAR = 1
SIGMA  = 0.2
EDIFF  = 1E-6
EDIFFG = -0.02
IBRION = 2
ISIF   = 3
NSW    = 100
LREAL  = Auto
```

### 7.2 金属：静的計算（エネルギー・DOS前処理）
```
SYSTEM = metal_static
ENCUT  = (手動で固定)
PREC   = Accurate
ISMEAR = 1
SIGMA  = 0.1
EDIFF  = 1E-8
IBRION = -1
NSW    = 0
LREAL  = .FALSE.
LORBIT = 11
```

### 7.3 強磁性（FM）
```
SYSTEM = FM_relax
ISPIN  = 2
MAGMOM = (原子数ぶん，初期値を与える)
ENCUT  = (手動で固定)
PREC   = Accurate
ISMEAR = 1
SIGMA  = 0.2
EDIFF  = 1E-6
EDIFFG = -0.02
IBRION = 2
ISIF   = 3
NSW    = 100
LORBIT = 11
```

### 7.4 SOC（例：方向を変えて回す）
```
SYSTEM  = SOC_nscf
LSORBIT = .TRUE.
ICHARG  = 11
ENCUT   = (手動で固定)
PREC    = Accurate
ISMEAR  = 1
SIGMA   = 0.1
EDIFF   = 1E-8
SAXIS   = 0 0 1
LORBIT  = 11
```

## 8. 出力の見方
- OSZICAR：電子反復の収束、magの推移（磁性の有無の一次判定）
- OUTCAR：E0やエントロピー項、サイト・軌道分解磁気モーメント（LORBIT設定時）
- CONTCAR：緩和後構造（次計算へ引き継ぐ）
- vasprun.xml / PROCAR / DOSCAR：後処理（バンド、DOS、投影解析）

## 9. 注意点
- 構造緩和が不安定：金属でISMEAR/SIGMAが不適切、k点不足、EDIFF/EDIFFGの整合不足を疑う。
- 磁性が消える：初期MAGMOMが弱い、対称性で平均化される、再開時にMAGMOMを落とした、を疑う。
- SOC結果が揺れる：k点と電子収束を強化し、ISYMを切った場合と比較し、全方向で入力を一致させる。

## まとめ
VASPで金属・磁性体を安定に計算する要点は、スミアリングとk点、初期磁気配置、対称性の4点を「収束設計」として固定することである。SOCや磁気異方性のような微小差分では、設定一致と収束の徹底が最重要であり、まず基底状態（コリニア）を確立してから非自己無撞着SOCへ派生させるのが実務的である。


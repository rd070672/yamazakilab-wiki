# リートベルト解析

リートベルト解析は、粉末回折で得られる強度プロファイル全体を、結晶構造モデルと装置・試料モデルに基づいて計算し、観測との差が最小となるように多数のパラメータを同時に最小二乗で精密化する方法である。単一ピークの積分強度を分離する従来手法に比べ、重なり合う反射を含めた全強度を一貫して扱える点が核心である。

## 参考ドキュメント
- H. M. Rietveld, A profile refinement method for nuclear and magnetic structures, Journal of Applied Crystallography 2, 65–71 (1969)
  https://journals.iucr.org/paper?a07067=
- R. J. Hill and C. J. Howard, Quantitative phase analysis from neutron powder diffraction data using the Rietveld method, Journal of Applied Crystallography 20, 467–474 (1987)
  https://journals.iucr.org/paper?s0021889887086199=
- 泉 富士夫, リートベルト法による結晶構造の精密化, 応用物理 59(1), 2–（1990, J-STAGE）
  https://www.jstage.jst.go.jp/article/oubutsu1932/59/1/59_1_2/_article/-char/ja

## 1. 粉末回折の観測量をモデルで再現する
粉末回折では、結晶配向がランダムであるとみなす限り、回折計が測るのは散乱ベクトルの大きさに関する情報、すなわち $2\theta$（または $Q$）に沿った一次元プロファイル $y(2\theta)$ である。単結晶のように反射ごとに独立な強度 $I_{hkl}$ を観測するのではなく、実データは
- 反射の重なり（高角ほど顕著）
- 装置の分解能関数（発散、軸発散、モノクロメータ、検出器）
- 試料の形状・吸収・透過
- 粒径・ひずみ・欠陥・テクスチャ
- 背景（散乱、蛍光、空気散乱など）
をまとめて含む。

このとき、反射を一つずつ切り分けて積分強度を求めるよりも、最初から全パターンを前向きに計算し、それをデータに合わせ込む方が情報保存的である。これがリートベルト解析である。

## 2. 観測式：計算プロファイルの基本形
離散点 $i=1,\dots,N$ における観測強度を $y_i^{\mathrm{obs}}$、計算強度を $y_i^{\mathrm{calc}}$ とする。基本形は次である。
$$
y_i^{\mathrm{calc}}
=
y_i^{\mathrm{bg}}
+
\sum_{p=1}^{P}
\; s_p \sum_{h\in p}
\;
m_{h}\, L_{h}\,
|F_{h}|^2\,
\Phi\!\left(2\theta_i-2\theta_{h}\right)\,
A_{h}\,P_{h}
$$
ここで

- $p$：相（phase）を表す番号、$P$ は相数
- $s_p$：相 $p$ のスケール因子
- $h$：反射（$hkl$）の集合（相 $p$ の結晶学で決まる）
- $m_h$：多重度
- $L_h$：ローレンツ因子＋偏光因子などの幾何学補正
- $F_h$：構造因子（X線なら原子散乱因子、中性子なら散乱長）
- $\Phi$：プロファイル関数（ピーク形状、幅、非対称などを含む）
- $2\theta_h$：ブラッグ条件で決まるピーク位置
- $A_h$：吸収・透過・試料変位などの補正
- $P_h$：配向（preferred orientation）や消衰などの補正
- $y_i^{\mathrm{bg}}$：背景モデル

この式は「反射ごとの寄与を足し合わせる」という形で直感的であるが、重要なのは $|F_h|^2$ と $\Phi$ が強く絡み合うことである。構造の情報は $F_h$ に、装置・微細組織の情報は $\Phi$ に主に入るが、両者は独立ではないため、推定したい量と固定すべき量の分離が解析の要になる。

## 3. 導出：重み付き最小二乗と線形化
### 3.1 目的関数
リートベルト解析は、重み $w_i$ を用いた残差平方和
$$
S(\mathbf{p})=\sum_{i=1}^{N} w_i\left(y_i^{\mathrm{obs}}-y_i^{\mathrm{calc}}(\mathbf{p})\right)^2
$$
を最小化する問題として定式化される。$\mathbf{p}$ は精密化パラメータ（格子定数、原子座標、温度因子、スケール、幅、ゼロ点、背景係数など）を並べたベクトルである。計数統計が支配的な場合、基本として $w_i \approx 1/\sigma_i^2$、ポアソン近似で $\sigma_i^2\approx y_i^{\mathrm{obs}}$ を用いる設計が多い。

### 3.2 ガウス–ニュートン型の線形化
求めたいのは $\mathbf{p}$ の更新量 $\Delta\mathbf{p}$ である。$y_i^{\mathrm{calc}}(\mathbf{p}+\Delta\mathbf{p})$ を一次で展開して
$$
y_i^{\mathrm{calc}}(\mathbf{p}+\Delta\mathbf{p})
\approx
y_i^{\mathrm{calc}}(\mathbf{p})
+
\sum_{j}
J_{ij}\,\Delta p_j,\qquad
J_{ij}=\frac{\partial y_i^{\mathrm{calc}}}{\partial p_j}
$$
とし、残差 $r_i = y_i^{\mathrm{obs}}-y_i^{\mathrm{calc}}(\mathbf{p})$ を用いると、正規方程式
$$
(\mathbf{J}^\top \mathbf{W}\mathbf{J})\,\Delta\mathbf{p}
=
\mathbf{J}^\top \mathbf{W}\,\mathbf{r}
$$
が得られる。ここで $\mathbf{W}=\mathrm{diag}(w_1,\dots,w_N)$ である。非線形性が強い場合はレーベンバーグ–マルカート型に
$$
(\mathbf{J}^\top \mathbf{W}\mathbf{J}+\lambda \mathbf{D})\,\Delta\mathbf{p}
=
\mathbf{J}^\top \mathbf{W}\,\mathbf{r}
$$
のような安定化項を入れる（$\mathbf{D}$ は対角行列など）。この枠組みが「全パターン最小二乗」である。

### 3.3 パラメータ相関という現象
$\mathbf{J}^\top \mathbf{W}\mathbf{J}$ が悪条件になると、異なるパラメータの効果が区別できず、推定値の不確かさが急増する。粉末回折では特に
- スケール因子と吸収・背景
- 温度因子と占有率
- 結晶子サイズとひずみ（ピーク幅）
- ゼロ点と格子定数
- 配向補正とサイト占有
などが絡みやすい。数式的には $J_{ij}$ の列が似てしまうことが原因である。したがって、何でも自由にすると情報を失う方向へ進み得るため、固定・拘束・段階的な導入が必要になる。

## 4. ブラッグ反射の位置：格子定数と回折幾何
ピーク位置はブラッグ条件
$$
2d_{hkl}\sin\theta_{hkl}=\lambda
$$
で決まる。指数 $(hkl)$ と格子定数（および晶系）から $d_{hkl}$ が出るため、パターン全体のピーク位置は格子定数に敏感である。ゼロ点ずれや試料高さずれは、外見上「格子定数の変化」と似た作用を持つため、位置補正パラメータの扱いは重要である。

## 5. 構造因子：何が強度を決めるか
### 5.1 X線の場合
結晶構造因子は
$$
F_{hkl}=\sum_{j}
o_j f_j(\sin\theta/\lambda)
\exp\!\left[2\pi i(hx_j+ky_j+lz_j)\right]
\exp\!\left(-B_j\frac{\sin^2\theta}{\lambda^2}\right)
$$
である（$j$ は原子サイト、$o_j$ は占有率、$f_j$ は原子散乱因子、$B_j$ は等方温度因子、$(x_j,y_j,z_j)$ は分率座標）。観測強度は基本として $|F_{hkl}|^2$ に比例する。

含意は明確である。
- 原子座標の微小な変化は、特定反射の位相因子を通じて強度差を生む
- 占有率と温度因子はどちらも高角で強度を下げる方向に作用し、区別が難しい
- 重元素は $f_j$ が大きく、軽元素は見えにくい（ただし条件次第で例外もある）

### 5.2 中性子の場合
中性子では $f_j$ の代わりに散乱長 $b_j$ が入り、元素依存がX線と大きく異なる。軽元素位置、同位体置換、磁気散乱の取り扱いなどで力を発揮する。

### 5.3 磁気構造との関係
原論文タイトルが核・磁気構造であるように、リートベルト法は中性子粉末回折の磁気構造解析とも深く結びつく。スピン配置は磁気構造因子として現れ、核散乱とは異なる選択則と偏極因子を持つ。粉末平均により方向情報は失われるが、磁気反射の出現と強度分布から秩序パラメータやモーメントの大きさを議論できる。

## 6. プロファイル関数：ピークの形と幅の物理
観測ピークはデルタ関数ではなく、有限幅と非対称を持つ。これを $\Phi$ で表す。基本として
- 装置由来：発散、検出器、波長分布（$K\alpha_1/K\alpha_2$ など）、軸発散
- 試料由来：結晶子サイズ、微小ひずみ、積層欠陥、テクスチャ
が畳み込まれる。

### 6.1 代表的な形
- ガウス：分解能や統計的広がりの表現に適合しやすい
- ローレンツ：サイズ広がりや欠陥由来の裾を表しやすい
- 擬フォークト（pseudo-Voigt）：ガウスとローレンツの混合で柔軟性が高い
- TCH（Thompson–Cox–Hastings）型：擬フォークトのパラメータ化として広く使われる

ピーク幅は $2\theta$ に依存して変化することが多く、例えば
$$
H^2 = U\tan^2\theta + V\tan\theta + W
$$
のような経験式で表し、$U,V,W$ を精密化する設計が多い（装置・試料の寄与が混ざることに注意する）。

### 6.2 結晶子サイズと微小ひずみ
微細組織起源の幅広がりは、単純化すると
$$
\beta_{\mathrm{size}}\propto \frac{\lambda}{D\cos\theta},\qquad
\beta_{\mathrm{strain}}\propto \epsilon\tan\theta
$$
のように角度依存が異なる。これにより、サイズ $D$ と微小ひずみ $\epsilon$ を同時推定する構想が立つが、実データでは装置幅・非対称・重なりが絡むため、独立性は状況依存である。標準試料で装置関数を別途見積もり、試料寄与を分離する考え方がよく採られる。

### 6.3 非対称と低角領域
低角の非対称（軸発散など）は、構造パラメータよりも位置パラメータや幅パラメータに強く影響し、格子定数やテクスチャと混線しやすい。非対称モデルを入れるか、角度範囲を吟味するかは目的量次第である。

## 7. 背景：構造の情報を削らない設計
背景 $y^{\mathrm{bg}}$ は、回折ピーク以外の散乱成分を表す。多項式、チェビシェフ、多点スプラインなどで表すことが多い。
背景の自由度が大きすぎると、ピーク裾の物理（サイズ・欠陥）に相当する成分まで吸収してしまう。逆に自由度が小さすぎると、差分曲線に系統的な歪みが残り、構造因子の精密化を誤る。背景は「必要十分」に留め、差分曲線の形を見ながら調整する思想が重要である。

## 8. 定量相分析：スケール因子から質量分率へ
複数相を含む粉末回折では、相分率の定量が主要目的になる。リートベルト解析では各相のスケール因子 $s_p$ が精密化されるが、スケール因子は相の量と構造因子・単位胞情報が混ざった量である。

Hill–Howard の式として、全相が既知で結晶性であるとき、相 $p$ の質量分率 $W_p$ は基本として
$$
W_p=\frac{s_p Z_p M_p V_p}{\sum_{k=1}^{P} s_k Z_k M_k V_k}
$$
で与えられる。ここで
- $Z_p$：単位胞中の化学式数
- $M_p$：化学式量（モル質量）
- $V_p$：単位胞体積
である。重要なのは、構造モデルが必要であること、未知相やアモルファス成分があると分母が崩れることである。アモルファスが混ざる場合は内部標準法や外部補正など別の設計が必要になる。

## 9. 適合度指標：$R$ 因子と $\chi^2$
観測と計算の一致を数値化する指標が多数ある。代表例は次である。
$$
R_p=
\frac{\sum_i |y_i^{\mathrm{obs}}-y_i^{\mathrm{calc}}|}{\sum_i y_i^{\mathrm{obs}}},\qquad
R_{wp}=
\left[
\frac{\sum_i w_i(y_i^{\mathrm{obs}}-y_i^{\mathrm{calc}})^2}{\sum_i w_i (y_i^{\mathrm{obs}})^2}
\right]^{1/2}
$$
期待値に基づく $R_e$ を用いると
$$
\chi^2=\left(\frac{R_{wp}}{R_e}\right)^2
$$
の形で議論されることが多い。

ただし、$R$ 因子は単純に小さいほど良いとは限らない。データ点数、背景の自由度、重み付け、系統誤差の有無などで値が動く。基礎としては
- 差分曲線に系統的な形が残っていないか
- 強い反射・弱い反射が同時に再現されているか
- 異なる角度領域でずれの性質が変わらないか
といった形状の解釈と併用する必要がある。

## 10. 近縁手法との比較：何が必要で何が返るか
| 方法 | 必要な入力 | 観測の扱い | 主な出力 | 構造モデル |
|---|---|---|---|---|
| ピーク分離＋積分強度 | ピーク位置と分離の仮定 | 反射ごとに部分的 | 個別反射強度、格子定数 | 不要または限定的 |
| Pawley 法 | 格子定数、空間群、反射リスト | 全パターンだが構造因子なし | 反射強度（整合した集合） | 不要 |
| Le Bail 法 | 格子定数、空間群、反射リスト | 全パターンで強度を割り当て | 反射強度（反復的割当） | 不要 |
| リートベルト解析 | 結晶構造、装置・試料モデル | 全パターン最小二乗 | 原子座標、占有率、温度因子、相分率、幅、配向など | 必要 |

Pawley/Le Bail は構造未知でも単位胞や反射強度を引き出せるため、構造決定の入口として有用である。一方で、サイト占有や原子位置といった構造情報を測るには、$F_{hkl}$ を明示するリートベルト解析が必要になる。

## 11. ソフトウェアと国内外の環境
リートベルト解析は多数の実装があるが、思想は共通である。代表例を挙げる。

- RIETAN-FP（国内で広く使われてきた系統、全パターンフィッティング、関連ツールとの連携が整備されてきた）
  配布情報の一例：https://jp-minerals.org/jp/
- GSAS-II（オープンソースの総合結晶学パッケージ、回折以外の機能も広い）
  論文：https://journals.iucr.org/paper?aj5212=
- FullProf（中性子回折、とりわけ磁気構造解析での利用が多い）
  国内解説例：https://neutron.appl-beam.ibaraki.ac.jp/Analysis/FullProf.html
- MAUD（回折に加え、テクスチャやサイズ・ひずみ等の複合モデルに強い設計）
  https://luttero.github.io/maud/
- Profex（BGMNを背後に持つGUIとしての位置づけ、粉末XRDでの解析支援）
  https://www.profex-xrd.org/

解析結果の再現性を担保するには、使用ソフト名だけでなく、プロファイル関数、配向補正、背景モデル、拘束条件などの記録が重要である。

## 12. 何が分かるか：材料研究で効く量
### 12.1 結晶構造の精密化
- 格子定数、原子座標、占有率、温度因子
- 固溶・置換でのサイト選好の傾向
- 温度や圧力に伴う対称性変化（相転移）

### 12.2 相分率と反応進行
- 多相混合の質量分率（結晶相が同定されていることが前提）
- 合成・熱処理での相変化の追跡
- その場回折（加熱・冷却・電場・磁場・応力）における相の出現消失

### 12.3 微細組織情報（幅・形状の解釈）
- 結晶子サイズ、微小ひずみの指標
- 方向依存広がり（転位や面欠陥の反映としてのモデル化）
- テクスチャ（配向）の存在と程度

粉末回折は平均化観測であるため、微細組織の推定はモデル依存性が高い。したがって、回折幅の議論は、電子顕微鏡観察や他の散乱法、あるいは標準試料を用いた装置幅の把握と併用すると解釈の射程が伸びる。

## 13. 解析を安定させるための考え方（言い換えると、うまくいかない理由の整理）
ここでは禁則語を避けつつ、失敗の原因を理屈として整理する。

1) 初期モデルが遠い
計算ピークと観測ピークの重なりが小さいと、$J_{ij}$ の情報が有効に働かず、更新が暴れるか停滞する。格子定数、空間群、相の同定は初期段階の支配要因である。

2) 自由度がデータの情報量を超える
背景係数、幅関数、非対称、配向、占有率などを同時に自由にすると、同じ残差減少を複数のパラメータが肩代わりでき、物理的に意味の薄い解に流れる。相関の強い組は固定・拘束・段階導入で分離する思想が有効である。

3) 装置・試料モデルの不足
低角の非対称、波長成分、試料変位、吸収・透過などが未記述だと、構造パラメータがそれを無理に吸収し、結合長や占有率などが歪む。

4) 未同定成分の混入
未知相やアモルファス成分は、背景やスケール、幅の推定に影響する。相分率定量の式は「全相が結晶で同定されている」条件に依存する。

## 14. 応用例の見取り図：研究目的からモデル選択へ
目的ごとに、モデルの優先順位が変わる。

- 相分率を主とする場合
  スケール因子の安定性が最大の関心事であり、背景、吸収、配向の扱いが支配的になりやすい。

- 格子定数変化を主とする場合
  ゼロ点や試料変位、波長、低角非対称を適切に扱うことが効く。温度依存の議論では熱膨張の物理と整合するかも重要である。

- サイト占有を主とする場合
  占有率と温度因子の相関を緩和する工夫が必要になる。X線と中性子で感度が異なるため、測定条件や併用データが有効になることが多い。

- 微細組織を主とする場合
  装置幅を別途見積もり、試料幅に帰属させる。方向依存幅モデルやテクスチャを同時に扱う場合、データ品質（分解能、角度範囲）が強く効く。

## 15. まとめ
リートベルト解析は、粉末回折プロファイル全体を、結晶構造因子 $|F_{hkl}|^2$ とプロファイル関数 $\Phi$ を核とする前向きモデルで記述し、重み付き最小二乗により多数のパラメータを同時に精密化する方法である。相分率、格子定数、原子座標、占有率、微細組織指標などを一つの枠組みで推定できる一方、パラメータ相関とモデル依存性が本質的に存在するため、目的量に対して装置・試料・構造のどの自由度を優先し、どこを固定・拘束するかを数式の構造として理解して設計することが要になる。

## 関連研究
1. B. H. Toby and R. B. Von Dreele, GSAS-II: the genesis of a modern open-source all purpose crystallography software package, Journal of Applied Crystallography 46, 544–549 (2013)
   https://journals.iucr.org/paper?aj5212=
2. W. A. Dollase, Correction of intensities for preferred orientation in powder diffractometry: application of the March model, Journal of Applied Crystallography 19, 267–272 (1986)
   https://doi.org/10.1107/S0021889886089458
3. G. S. Pawley, Unit-cell refinement from powder diffraction scans, Journal of Applied Crystallography 14, 357–361 (1981)
   https://journals.iucr.org/paper?a20546=
4. H. TORAYA, プロファイル関数とパターン分解法, 日本結晶学会誌 34(2), 86–（1992, J-STAGE）
   https://www.jstage.jst.go.jp/article/jcrsj1959/34/2/34_2_86/_article/-char/ja
5. 泉 富士夫, RIETAN-FP・VENUS システムと外部プログラムによる粉末回折データ解析, まてりあ 56(6), 393–（2017, J-STAGE）
   https://www.jstage.jst.go.jp/article/materia/56/6/56_56.393/_pdf
6. N. Doebelin and R. Kleeberg, Profex: a graphical user interface for the Rietveld refinement program BGMN, Journal of Applied Crystallography 48, 1573–1580 (2015)
   https://pmc.ncbi.nlm.nih.gov/articles/PMC4603273/
7. MAUD (Materials Analysis Using Diffraction) 公式情報
   https://luttero.github.io/maud/
8. XRD-Rietveld法の国内応用例（鉄鋼材料における相定量など）
   https://www.jstage.jst.go.jp/article/tetsutohagane/107/3/107_TETSU-2020-098/_html/-char/ja
9. XRD/リートベルト法の国内応用例（セメント系材料の定量）
   https://www.jstage.jst.go.jp/article/coj/56/5/56_448/_pdf
